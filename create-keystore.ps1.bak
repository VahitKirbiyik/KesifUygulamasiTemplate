# ğŸ” KesifApp Keystore OluÅŸturma Scripti

param(
    [string]$KeystorePath = ".\keystore\kesifapp.keystore",
    [string]$KeyAlias = "kesifapp_key",
    [string]$KeyPassword,
    [string]$StorePassword,
    [int]$ValidityDays = 10000,
    [switch]$Help
)

# Script bilgileri
$ScriptVersion = "1.0.0"
$LastUpdated = "30 AÄŸustos 2025"

# Renk tanÄ±mlarÄ±
$Green = "Green"
$Yellow = "Yellow"
$Red = "Red"
$Cyan = "Cyan"
$White = "White"

function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = $White
    )
    Write-Host $Message -ForegroundColor $Color
}

function Show-Help {
    Write-ColorOutput "`nğŸ” KesifApp Keystore Generator v$ScriptVersion" $Cyan
    Write-ColorOutput "Son gÃ¼ncelleme: $LastUpdated`n" $Yellow

    Write-ColorOutput "KULLANIM:" $Green
    Write-ColorOutput "  .\create-keystore.ps1 [parametreler]`n"

    Write-ColorOutput "PARAMETRELER:" $Green
    Write-ColorOutput "  -KeystorePath <path>     Keystore dosya yolu (varsayÄ±lan: .\keystore\kesifapp.keystore)"
    Write-ColorOutput "  -KeyAlias <alias>        Anahtar takma adÄ± (varsayÄ±lan: kesifapp_key)"
    Write-ColorOutput "  -KeyPassword <pass>      Anahtar ÅŸifresi"
    Write-ColorOutput "  -StorePassword <pass>    Keystore ÅŸifresi"
    Write-ColorOutput "  -ValidityDays <days>     GeÃ§erlilik sÃ¼resi (varsayÄ±lan: 10000 gÃ¼n)"
    Write-ColorOutput "  -Help                    Bu yardÄ±m mesajÄ±nÄ± gÃ¶sterir`n"

    Write-ColorOutput "Ã–RNEKLER:" $Green
    Write-ColorOutput "  .\create-keystore.ps1"
    Write-ColorOutput "  .\create-keystore.ps1 -KeyPassword 'MyKeyPass123' -StorePassword 'MyStorePass123'"
    Write-ColorOutput "  .\create-keystore.ps1 -KeystorePath '.\myapp.keystore' -ValidityDays 3650`n"

    Write-ColorOutput "GÃœVENLÄ°K NOTLARI:" $Yellow
    Write-ColorOutput "  - Åifrelerinizi gÃ¼venli bir yerde saklayÄ±n"
    Write-ColorOutput "  - Keystore dosyasÄ±nÄ± yedekleyin"
    Write-ColorOutput "  - Åifreleri kod iÃ§inde saklamayÄ±n"
    Write-ColorOutput "  - DÃ¼zenli olarak keystore'u yenileyin`n"
}

function Test-Prerequisites {
    Write-ColorOutput "`nğŸ” Gereksinim kontrolÃ¼ yapÄ±lÄ±yor..." $Cyan

    # Java keytool kontrolÃ¼
    try {
        $keytoolVersion = keytool -version 2>&1
        Write-ColorOutput "âœ… Java Keytool: $keytoolVersion" $Green
    }
    catch {
        Write-ColorOutput "âŒ Java Keytool bulunamadÄ±. LÃ¼tfen JDK yÃ¼kleyin." $Red
        return $false
    }

    Write-ColorOutput "ğŸ‰ Gereksinimler saÄŸlandÄ±!`n" $Green
    return $true
}

function Create-KeystoreDirectory {
    $keystoreDir = Split-Path $KeystorePath -Parent

    if (-not (Test-Path $keystoreDir)) {
        try {
            New-Item -ItemType Directory -Path $keystoreDir -Force | Out-Null
            Write-ColorOutput "ğŸ“ Keystore klasÃ¶rÃ¼ oluÅŸturuldu: $keystoreDir" $Green
        }
        catch {
            Write-ColorOutput "âŒ Keystore klasÃ¶rÃ¼ oluÅŸturulamadÄ±: $($_.Exception.Message)" $Red
            return $false
        }
    }

    return $true
}

function Generate-Passwords {
    if (-not $KeyPassword) {
        $script:KeyPassword = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | ForEach-Object {[char]$_})
        Write-ColorOutput "ğŸ”‘ Rastgele anahtar ÅŸifresi oluÅŸturuldu" $Yellow
    }

    if (-not $StorePassword) {
        $script:StorePassword = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | ForEach-Object {[char]$_})
        Write-ColorOutput "ğŸ” Rastgele keystore ÅŸifresi oluÅŸturuldu" $Yellow
    }
}

function Create-Keystore {
    Write-ColorOutput "`nğŸ” Keystore oluÅŸturuluyor..." $Cyan

    # Sertifika bilgileri
    $dname = "CN=KesifApp, OU=Development, O=Vahit Kirbiyik, L=Istanbul, ST=Turkey, C=TR"

    $keytoolArgs = @(
        "-genkeypair",
        "-v",
        "-keystore", $KeystorePath,
        "-alias", $KeyAlias,
        "-keyalg", "RSA",
        "-keysize", "2048",
        "-validity", $ValidityDays,
        "-storepass", $StorePassword,
        "-keypass", $KeyPassword,
        "-dname", $dname
    )

    try {
        & keytool $keytoolArgs
        Write-ColorOutput "âœ… Keystore baÅŸarÄ±yla oluÅŸturuldu" $Green
        return $true
    }
    catch {
        Write-ColorOutput "âŒ Keystore oluÅŸturma baÅŸarÄ±sÄ±z: $($_.Exception.Message)" $Red
        return $false
    }
}

function Verify-Keystore {
    Write-ColorOutput "`nğŸ” Keystore doÄŸrulanÄ±yor..." $Cyan

    try {
        $listResult = & keytool -list -v -keystore $KeystorePath -storepass $StorePassword 2>&1

        if ($listResult -match $KeyAlias) {
            Write-ColorOutput "âœ… Keystore doÄŸrulandÄ± - Anahtar bulundu: $KeyAlias" $Green
            return $true
        }
        else {
            Write-ColorOutput "âŒ Keystore doÄŸrulama baÅŸarÄ±sÄ±z - Anahtar bulunamadÄ±" $Red
            return $false
        }
    }
    catch {
        Write-ColorOutput "âŒ Keystore doÄŸrulama hatasÄ±: $($_.Exception.Message)" $Red
        return $false
    }
}

function Show-Summary {
    Write-ColorOutput "`nğŸŠ KEYSTORE Ã–ZETÄ°" $Cyan
    Write-ColorOutput "=" * 50 $Cyan

    Write-ColorOutput "ğŸ“ Keystore Yolu: $KeystorePath" $Green
    Write-ColorOutput "ğŸ”‘ Anahtar Takma AdÄ±: $KeyAlias" $Green
    Write-ColorOutput "ğŸ“… GeÃ§erlilik: $ValidityDays gÃ¼n" $Green
    Write-ColorOutput "ğŸ” Keystore Åifresi: $StorePassword" $Yellow
    Write-ColorOutput "ğŸ”‘ Anahtar Åifresi: $KeyPassword" $Yellow

    Write-ColorOutput "`nâš ï¸  Ã–NEMLÄ° GÃœVENLÄ°K UYARILARI:" $Red
    Write-ColorOutput "  â€¢ Bu ÅŸifreleri gÃ¼venli bir yerde saklayÄ±n" $White
    Write-ColorOutput "  â€¢ Keystore dosyasÄ±nÄ± yedekleyin" $White
    Write-ColorOutput "  â€¢ Åifreleri paylaÅŸmayÄ±n" $White
    Write-ColorOutput "  â€¢ DÃ¼zenli olarak keystore'u kontrol edin" $White

    Write-ColorOutput "`nğŸš€ SONRAKÄ° ADIMLAR:" $Yellow
    Write-ColorOutput "1. Åifreleri gÃ¼venli bir yerde saklayÄ±n" $White
    Write-ColorOutput "  Ã–rnek: password-manager, gÃ¼venli notlar" $White
    Write-ColorOutput "2. Keystore dosyasÄ±nÄ± yedekleyin" $White
    Write-ColorOutput "  Ã–rnek: USB drive, cloud storage (encrypted)" $White
    Write-ColorOutput "3. Build scriptinde ÅŸifreleri kullanÄ±n" $White
    Write-ColorOutput "  Ã–rnek: .\build-aab.ps1 -KeystorePassword '$StorePassword'" $White

    Write-ColorOutput "`nğŸ“ DESTEK:" $Yellow
    Write-ColorOutput "GitHub: https://github.com/VahitKirbiyik/KesifUygulamasiTemplate" $White
    Write-ColorOutput "Issues: https://github.com/VahitKirbiyik/KesifUygulamasiTemplate/issues" $White
}

function Save-Passwords {
    $passwordFile = Join-Path (Split-Path $KeystorePath -Parent) "keystore-passwords.txt"

    try {
        $passwordContent = @"
# KesifApp Keystore Åifreleri
# OluÅŸturulma Tarihi: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
# GeÃ§erlilik SÃ¼resi: $ValidityDays gÃ¼n

KEYSTORE_PATH=$KeystorePath
KEY_ALIAS=$KeyAlias
STORE_PASSWORD=$StorePassword
KEY_PASSWORD=$KeyPassword

# GÃœVENLÄ°K UYARISI:
# Bu dosyayÄ± gÃ¼venli bir yerde saklayÄ±n
# Åifreleri kod iÃ§inde kullanmayÄ±n
# DÃ¼zenli olarak ÅŸifreleri deÄŸiÅŸtirin
"@

        $passwordContent | Out-File -FilePath $passwordFile -Encoding UTF8
        Write-ColorOutput "ğŸ’¾ Åifreler kaydedildi: $passwordFile" $Green
        Write-ColorOutput "âš ï¸  Bu dosyayÄ± gÃ¼venli bir yerde saklayÄ±n!" $Red
    }
    catch {
        Write-ColorOutput "âŒ Åifre dosyasÄ± kaydedilemedi: $($_.Exception.Message)" $Yellow
    }
}

# Ana script mantÄ±ÄŸÄ±
function Main {
    if ($Help) {
        Show-Help
        return
    }

    Write-ColorOutput "`nğŸš€ KesifApp Keystore Generator baÅŸlatÄ±lÄ±yor..." $Cyan
    Write-ColorOutput "Versiyon: $ScriptVersion | Tarih: $LastUpdated" $Yellow

    # Gereksinim kontrolÃ¼
    if (-not (Test-Prerequisites)) {
        Write-ColorOutput "`nâŒ Gereksinimler saÄŸlanamadÄ±. Script durduruluyor." $Red
        exit 1
    }

    # Keystore klasÃ¶rÃ¼ oluÅŸtur
    if (-not (Create-KeystoreDirectory)) {
        exit 1
    }

    # Åifreleri oluÅŸtur
    Generate-Passwords

    # Keystore oluÅŸtur
    if (-not (Create-Keystore)) {
        exit 1
    }

    # Keystore doÄŸrula
    if (-not (Verify-Keystore)) {
        exit 1
    }

    # Åifreleri kaydet
    Save-Passwords

    # Ã–zet gÃ¶ster
    Show-Summary

    Write-ColorOutput "`nğŸ‰ KesifApp keystore baÅŸarÄ±yla oluÅŸturuldu!" $Green
    Write-ColorOutput "ArtÄ±k uygulamalarÄ±nÄ±zÄ± imzalayabilirsiniz! ğŸ”`n" $Green
}

# Script'i Ã§alÄ±ÅŸtÄ±r
Main
