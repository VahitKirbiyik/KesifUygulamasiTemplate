name: ğŸ”’ Legal & Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  legal-check:
    name: "Legal Compliance Check"
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“‹ LICENSE File Check
      run: |
        if [ -f "LICENSE" ]; then
          echo "âœ… LICENSE dosyasÄ± bulundu"
          head -5 LICENSE
        else
          echo "âŒ LICENSE dosyasÄ± bulunamadÄ±!"
          exit 1
        fi

    - name: ğŸ”’ Privacy Policy Check
      run: |
        if [ -f "legal/privacy-policy.html" ]; then
          echo "âœ… Gizlilik politikasÄ± bulundu"
          grep -i "gizlilik\|privacy" legal/privacy-policy.html | head -3
        else
          echo "âŒ Gizlilik politikasÄ± bulunamadÄ±!"
          exit 1
        fi

    - name: ğŸ“– README License Section Check
      run: |
        if grep -q "## Lisans\|## License" README.md; then
          echo "âœ… README'de lisans bÃ¶lÃ¼mÃ¼ bulundu"
        else
          echo "âš ï¸  README'de lisans bÃ¶lÃ¼mÃ¼ bulunamadÄ±"
        fi

  security-scan:
    name: "Security Scan"
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Security Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  dependency-check:
    name: "Dependency Vulnerability Check"
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'KesifUygulamasiTemplate'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --nvdValidForHours 24

    - name: ğŸ“¤ Upload Dependency Check results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-report
        path: reports/

  compliance-summary:
    name: "Compliance Summary"
    runs-on: ubuntu-latest
    needs: [legal-check, security-scan, dependency-check]
    if: always()
    steps:
    - name: ğŸ“Š Generate Compliance Report
      run: |
        echo "# ğŸ”’ GÃ¼venlik ve Uyumluluk Raporu" > compliance-report.md
        echo "" >> compliance-report.md
        echo "## ğŸ“‹ Kontrol SonuÃ§larÄ±" >> compliance-report.md
        echo "" >> compliance-report.md

        if [ "${{ needs.legal-check.result }}" == "success" ]; then
          echo "âœ… **Legal Check:** BaÅŸarÄ±lÄ±" >> compliance-report.md
        else
          echo "âŒ **Legal Check:** BaÅŸarÄ±sÄ±z" >> compliance-report.md
        fi

        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… **Security Scan:** BaÅŸarÄ±lÄ±" >> compliance-report.md
        else
          echo "âŒ **Security Scan:** BaÅŸarÄ±sÄ±z" >> compliance-report.md
        fi

        if [ "${{ needs.dependency-check.result }}" == "success" ]; then
          echo "âœ… **Dependency Check:** BaÅŸarÄ±lÄ±" >> compliance-report.md
        else
          echo "âŒ **Dependency Check:** BaÅŸarÄ±sÄ±z" >> compliance-report.md
        fi

        echo "" >> compliance-report.md
        echo "## ğŸ“… Kontrol Tarihi" >> compliance-report.md
        echo "$(date)" >> compliance-report.md
        echo "" >> compliance-report.md
        echo "---" >> compliance-report.md
        echo "*Bu rapor otomatik olarak GitHub Actions tarafÄ±ndan oluÅŸturulmuÅŸtur.*" >> compliance-report.md

    - name: ğŸ“¤ Upload Compliance Report
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance-report.md

    - name: ğŸ“¢ Notification
      if: failure()
      run: |
        echo "âš ï¸  Uyumluluk kontrolÃ¼ baÅŸarÄ±sÄ±z oldu!"
        echo "Detaylar iÃ§in artifacts bÃ¶lÃ¼mÃ¼nÃ¼ kontrol edin."
