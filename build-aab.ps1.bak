# ğŸ“¦ KesifApp Android App Bundle OluÅŸturma Scripti

param(
    [string]$Configuration = "Release",
    [string]$OutputPath = ".\publish",
    [string]$KeystorePath = ".\keystore\kesifapp.keystore",
    [SecureString]$KeystorePassword,
    [string]$KeyAlias = "kesifapp_key",
    [switch]$Clean,
    [switch]$NoSign,
    [switch]$Help
)

# Script bilgileri
$ScriptVersion = "1.0.0"
$LastUpdated = "30 AÄŸustos 2025"

# Renk tanÄ±mlarÄ±
$Green = "Green"
$Yellow = "Yellow"
$Red = "Red"
$Cyan = "Cyan"
$White = "White"

function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = $White
    )
    Write-Host $Message -ForegroundColor $Color
}

function Show-Help {
    Write-ColorOutput "`nğŸ“¦ KesifApp Android App Bundle Builder v$ScriptVersion" $Cyan
    Write-ColorOutput "Son gÃ¼ncelleme: $LastUpdated`n" $Yellow

    Write-ColorOutput "KULLANIM:" $Green
    Write-ColorOutput "  .\build-aab.ps1 [parametreler]`n"

    Write-ColorOutput "PARAMETRELER:" $Green
    Write-ColorOutput "  -Configuration <config>    Build konfigÃ¼rasyonu (varsayÄ±lan: Release)"
    Write-ColorOutput "  -OutputPath <path>         Ã‡Ä±ktÄ± klasÃ¶rÃ¼ (varsayÄ±lan: .\publish)"
    Write-ColorOutput "  -KeystorePath <path>       Keystore dosya yolu"
    Write-ColorOutput "  -KeystorePassword <pass>   Keystore ÅŸifresi (varsayÄ±lan: Ã§evre deÄŸiÅŸkeninden)"
    Write-ColorOutput "  -KeyAlias <alias>          Anahtar takma adÄ± (varsayÄ±lan: kesifapp_key)"
    Write-ColorOutput "  -Clean                     Temiz build yapar"
    Write-ColorOutput "  -NoSign                    Ä°mzalama yapmadan build eder"
    Write-ColorOutput "  -Help                      Bu yardÄ±m mesajÄ±nÄ± gÃ¶sterir`n"

    Write-ColorOutput "Ã–RNEKLER:" $Green
    Write-ColorOutput "  .\build-aab.ps1"
    Write-ColorOutput "  .\build-aab.ps1 -Configuration Debug -NoSign"
    Write-ColorOutput "  .\build-aab.ps1 -Clean -OutputPath .\output`n"

    Write-ColorOutput "GEREKSÄ°NÄ°MLER:" $Yellow
    Write-ColorOutput "  - .NET 8.0 SDK"
    Write-ColorOutput "  - Android SDK (API 34)"
    Write-ColorOutput "  - Java JDK 17+"
    Write-ColorOutput "  - Android keystore (imzalama iÃ§in)`n"
}

function Test-Prerequisites {
    Write-ColorOutput "`nğŸ” Gereksinim kontrolÃ¼ yapÄ±lÄ±yor..." $Cyan

    # .NET SDK kontrolÃ¼
    try {
        $dotnetVersion = dotnet --version
        Write-ColorOutput "âœ… .NET SDK: $dotnetVersion" $Green
    }
    catch {
        Write-ColorOutput "âŒ .NET SDK bulunamadÄ±. LÃ¼tfen .NET 8.0 SDK yÃ¼kleyin." $Red
        return $false
    }

    # Android SDK kontrolÃ¼
    $androidHome = $env:ANDROID_HOME
    if ($androidHome -and (Test-Path $androidHome)) {
        Write-ColorOutput "âœ… Android SDK: $androidHome" $Green
    }
    else {
        Write-ColorOutput "âŒ Android SDK bulunamadÄ±. ANDROID_HOME Ã§evre deÄŸiÅŸkenini ayarlayÄ±n." $Red
        return $false
    }

    # Java kontrolÃ¼
    try {
        $javaVersion = java -version 2>&1 | Select-String "version"
        Write-ColorOutput "âœ… Java: $javaVersion" $Green
    }
    catch {
        Write-ColorOutput "âŒ Java JDK bulunamadÄ±. LÃ¼tfen JDK 17+ yÃ¼kleyin." $Red
        return $false
    }

    # Keystore kontrolÃ¼
    if (-not $NoSign) {
        if (Test-Path $KeystorePath) {
            Write-ColorOutput "âœ… Keystore: $KeystorePath" $Green
        }
        else {
            Write-ColorOutput "âŒ Keystore bulunamadÄ±: $KeystorePath" $Red
            return $false
        }
    }

    Write-ColorOutput "ğŸ‰ TÃ¼m gereksinimler saÄŸlandÄ±!`n" $Green
    return $true
}

function CleanProject {
    Write-ColorOutput "`nğŸ§¹ Proje temizleniyor..." $Cyan

    try {
        dotnet clean
        Write-ColorOutput "âœ… Clean tamamlandÄ±" $Green
    }
    catch {
        Write-ColorOutput "âŒ Clean baÅŸarÄ±sÄ±z: $($_.Exception.Message)" $Red
        return $false
    }

    return $true
}

function Restore-Packages {
    Write-ColorOutput "`nğŸ“¦ NuGet paketleri geri yÃ¼kleniyor..." $Cyan

    try {
        dotnet restore
        Write-ColorOutput "âœ… Paket geri yÃ¼kleme tamamlandÄ±" $Green
    }
    catch {
        Write-ColorOutput "âŒ Paket geri yÃ¼kleme baÅŸarÄ±sÄ±z: $($_.Exception.Message)" $Red
        return $false
    }

    return $true
}

function Build-Project {
    Write-ColorOutput "`nğŸ”¨ Proje derleniyor..." $Cyan
    Write-ColorOutput "KonfigÃ¼rasyon: $Configuration" $Yellow

    try {
        dotnet build -c $Configuration --no-restore
        Write-ColorOutput "âœ… Build tamamlandÄ±" $Green
    }
    catch {
        Write-ColorOutput "âŒ Build baÅŸarÄ±sÄ±z: $($_.Exception.Message)" $Red
        return $false
    }

    return $true
}

function Publish-Android {
    Write-ColorOutput "`nğŸ“± Android App Bundle yayÄ±nlanÄ±yor..." $Cyan

    $publishArgs = @(
        "publish",
        "-c", $Configuration,
        "-f", "net8.0-android",
        "--android-platform", "34",
        "--self-contained",
        "-p:AndroidPackageFormat=aab",
        "-p:ApplicationId=com.vahit.kesifuygulamasi",
        "-p:ApplicationVersion=4",
        "-p:ApplicationDisplayVersion=1.0.0",
        "-o", $OutputPath
    )

    try {
        & dotnet $publishArgs
        Write-ColorOutput "âœ… Android publish tamamlandÄ±" $Green
    }
    catch {
        Write-ColorOutput "âŒ Android publish baÅŸarÄ±sÄ±z: $($_.Exception.Message)" $Red
        return $false
    }

    return $true
}

function SignBundle {
    if ($NoSign) {
        Write-ColorOutput "`nâ­ï¸  Ä°mzalama atlanÄ±yor (-NoSign parametresi)" $Yellow
        return $true
    }

    Write-ColorOutput "`nğŸ” App Bundle imzalanÄ±yor..." $Cyan

    # Keystore ÅŸifresini al
    if (-not $KeystorePassword) {
        $KeystorePassword = Read-Host "Keystore ÅŸifresini girin" -AsSecureString
        if (-not $KeystorePassword) {
            Write-ColorOutput "âŒ Keystore ÅŸifresi gerekli" $Red
            return $false
        }
    }

    $bundlePath = Join-Path $OutputPath "com.vahit.kesifuygulamasi-Signed.aab"
    $unsignedBundlePath = Get-ChildItem $OutputPath -Filter "*.aab" | Select-Object -First 1

    if (-not $unsignedBundlePath) {
        Write-ColorOutput "âŒ AAB dosyasÄ± bulunamadÄ±" $Red
        return $false
    }

    try {
        # jarsigner ile imzalama
        & jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 -keystore $KeystorePath -storepass $KeystorePassword -keypass $KeystorePassword $unsignedBundlePath.FullName $KeyAlias

        # Ä°mzalÄ± dosyayÄ± yeniden adlandÄ±r
        Move-Item $unsignedBundlePath.FullName $bundlePath -Force

        Write-ColorOutput "âœ… Ä°mzalama tamamlandÄ±: $bundlePath" $Green
    }
    catch {
        Write-ColorOutput "âŒ Ä°mzalama baÅŸarÄ±sÄ±z: $($_.Exception.Message)" $Red
        return $false
    }

    return $true
}

function VerifyBundle {
    Write-ColorOutput "`nğŸ” App Bundle doÄŸrulanÄ±yor..." $Cyan

    $bundlePath = Get-ChildItem $OutputPath -Filter "*.aab" | Select-Object -First 1

    if (-not $bundlePath) {
        Write-ColorOutput "âŒ AAB dosyasÄ± bulunamadÄ±" $Red
        return $false
    }

    # Dosya boyutu kontrolÃ¼
    $fileSize = (Get-Item $bundlePath.FullName).Length / 1MB
    Write-ColorOutput "ğŸ“Š Dosya boyutu: $([math]::Round($fileSize, 2)) MB" $Yellow

    if ($fileSize -gt 150) {
        Write-ColorOutput "âš ï¸  Dosya boyutu bÃ¼yÃ¼k (>150MB). Play Store limiti kontrol edin." $Yellow
    }

    # Ä°mza kontrolÃ¼
    if (-not $NoSign) {
        try {
            $verifyResult = & jarsigner -verify -verbose $bundlePath.FullName 2>&1
            if ($verifyResult -match "verified") {
                Write-ColorOutput "âœ… Ä°mza doÄŸrulandÄ±" $Green
            }
            else {
                Write-ColorOutput "âŒ Ä°mza doÄŸrulanamadÄ±" $Red
                return $false
            }
        }
        catch {
            Write-ColorOutput "âŒ Ä°mza kontrolÃ¼ baÅŸarÄ±sÄ±z: $($_.Exception.Message)" $Red
            return $false
        }
    }

    Write-ColorOutput "âœ… Bundle doÄŸrulama tamamlandÄ±" $Green
    return $true
}

function Show-Summary {
    Write-ColorOutput "`nğŸŠ BUILD Ã–ZETÄ°" $Cyan
    Write-ColorOutput "=" * 50 $Cyan

    $bundlePath = Get-ChildItem $OutputPath -Filter "*.aab" | Select-Object -First 1

    if ($bundlePath) {
        Write-ColorOutput "ğŸ“¦ App Bundle: $($bundlePath.FullName)" $Green
        Write-ColorOutput "ğŸ“Š Boyut: $([math]::Round((Get-Item $bundlePath.FullName).Length / 1MB, 2)) MB" $Green
        Write-ColorOutput "ğŸ“… OluÅŸturulma: $(Get-Item $bundlePath.FullName).CreationTime" $Green
    }

    Write-ColorOutput "`nğŸš€ SONRAKÄ° ADIMLAR:" $Yellow
    Write-ColorOutput "1. Google Play Console'a giriÅŸ yapÄ±n" $White
    Write-ColorOutput "2. KesifApp uygulamasÄ±nÄ± seÃ§in" $White
    Write-ColorOutput "3. 'Ãœretim' sekmesine gidin" $White
    Write-ColorOutput "4. App Bundle dosyasÄ±nÄ± yÃ¼kleyin" $White
    Write-ColorOutput "5. YayÄ±nlamayÄ± baÅŸlatÄ±n" $White

    Write-ColorOutput "`nğŸ“ DESTEK:" $Yellow
    Write-ColorOutput "GitHub: https://github.com/VahitKirbiyik/KesifUygulamasiTemplate" $White
    Write-ColorOutput "Issues: https://github.com/VahitKirbiyik/KesifUygulamasiTemplate/issues" $White
}

# Ana script mantÄ±ÄŸÄ±
function Main {
    if ($Help) {
        Show-Help
        return
    }

    Write-ColorOutput "`nğŸš€ KesifApp Android App Bundle Builder baÅŸlatÄ±lÄ±yor..." $Cyan
    Write-ColorOutput "Versiyon: $ScriptVersion | Tarih: $LastUpdated" $Yellow

    # Gereksinim kontrolÃ¼
    if (-not (Test-Prerequisites)) {
        Write-ColorOutput "`nâŒ Gereksinimler saÄŸlanamadÄ±. Script durduruluyor." $Red
        exit 1
    }

    # Ã‡Ä±ktÄ± klasÃ¶rÃ¼ oluÅŸtur
    if (-not (Test-Path $OutputPath)) {
        New-Item -ItemType Directory -Path $OutputPath | Out-Null
        Write-ColorOutput "ğŸ“ Ã‡Ä±ktÄ± klasÃ¶rÃ¼ oluÅŸturuldu: $OutputPath" $Green
    }

    # Temizleme
    if ($Clean) {
        if (-not (CleanProject)) {
            exit 1
        }
    }

    # Paket geri yÃ¼kleme
    if (-not (Restore-Packages)) {
        exit 1
    }

    # Build
    if (-not (Build-Project)) {
        exit 1
    }

    # Android publish
    if (-not (Publish-Android)) {
        exit 1
    }

    # Ä°mzalama
    if (-not (SignBundle)) {
        exit 1
    }

    # DoÄŸrulama
    if (-not (VerifyBundle)) {
        exit 1
    }

    # Ã–zet
    Show-Summary

    Write-ColorOutput "`nğŸ‰ KesifApp App Bundle baÅŸarÄ±yla oluÅŸturuldu!" $Green
    Write-ColorOutput "ArtÄ±k Play Store'a yÃ¼klemeye hazÄ±rsÄ±nÄ±z! ğŸš€`n" $Green
}

# Script'i Ã§alÄ±ÅŸtÄ±r
Main
