# SECURITY.md\n\n## Güvenlik Politikası ve Prosedürleri\n\nBu dokümanda KesifUygulamasiTemplate projesinin güvenlik politikaları, token doğrulama prosedürleri ve güvenlik en iyi uygulamaları açıklanmaktadır.\n\n## 🔐 Güvenlik Genel Bakış\n\n### Desteklenen Kimlik Doğrulama Türleri\n\n1. **JWT (JSON Web Tokens)**\n   - HS256 algoritması ile imzalanmış token'lar\n   - 24 saatlik maksimum geçerlilik süresi\n   - Zorunlu claim'ler: `iss`, `aud`, `exp`, `iat`, `sub`\n\n2. **OAuth 2.0**\n   - Authorization Code Grant akışı\n   - PKCE (Proof Key for Code Exchange) desteği\n   - Refresh token rotasyonu\n\n3. **API Keys**\n   - HMAC-SHA256 ile imzalanmış istekler\n   - Rate limiting ve kullanım takibi\n   - Düzenli rotasyon politikası\n\n## 🛡️ Token Doğrulama Prosedürleri\n\n### JWT Token Doğrulama\n\n#### 1. Token Yapısı Kontrolü\n```csharp\n// JWT token yapısı kontrolü\npublic bool ValidateJwtStructure(string token)\n{\n    try\n    {\n        var parts = token.Split('.');\n        if (parts.Length != 3)\n            return false;\n\n        // Header, Payload ve Signature bölümlerinin base64url formatında olduğunu kontrol et\n        foreach (var part in parts)\n        {\n            Convert.FromBase64String(part.Replace('-', '+').Replace('_', '/'));\n        }\n\n        return true;\n    }\n    catch\n    {\n        return false;\n    }\n}\n```\n\n#### 2. Token İmza Doğrulama\n```csharp\n// JWT imza doğrulama\npublic bool ValidateJwtSignature(string token, string secretKey)\n{\n    try\n    {\n        var tokenHandler = new JwtSecurityTokenHandler();\n        var validationParameters = new TokenValidationParameters\n        {\n            ValidateIssuer = true,\n            ValidateAudience = true,\n            ValidateLifetime = true,\n            ValidateIssuerSigningKey = true,\n            ValidIssuer = _configuration["Jwt:Issuer"],\n            ValidAudience = _configuration["Jwt:Audience"],\n            IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey)),\n            ClockSkew = TimeSpan.Zero\n        };\n\n        tokenHandler.ValidateToken(token, validationParameters, out _);\n        return true;\n    }\n    catch\n    {\n        return false;\n    }\n}\n```\n\n#### 3. Token Claim Doğrulama\n```csharp\n// JWT claim doğrulama\npublic bool ValidateJwtClaims(JwtSecurityToken jwtToken)\n{\n    // Zorunlu claim'leri kontrol et\n    if (string.IsNullOrEmpty(jwtToken.Issuer))\n        return false;\n\n    if (string.IsNullOrEmpty(jwtToken.Audience))\n        return false;\n\n    if (jwtToken.ValidTo < DateTime.UtcNow)\n        return false;\n\n    // Özel claim'leri kontrol et\n    var userId = jwtToken.Claims.FirstOrDefault(c => c.Type == "userId")?.Value;\n    if (string.IsNullOrEmpty(userId))\n        return false;\n\n    var role = jwtToken.Claims.FirstOrDefault(c => c.Type == "role")?.Value;\n    if (string.IsNullOrEmpty(role))\n        return false;\n\n    return true;\n}\n```\n\n### OAuth Token Doğrulama\n\n#### 1. Access Token Doğrulama\n```csharp\n// OAuth access token doğrulama\npublic async Task<bool> ValidateOAuthToken(string accessToken)\n{\n    try\n    {\n        using var client = new HttpClient();\n        var request = new HttpRequestMessage(HttpMethod.Get, $"{_oauthAuthority}/oauth2/v2.0/token");\n        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);\n\n        var response = await client.SendAsync(request);\n        return response.IsSuccessStatusCode;\n    }\n    catch\n    {\n        return false;\n    }\n}\n```\n\n#### 2. Refresh Token Rotasyonu\n```csharp\n// Refresh token rotasyonu\npublic async Task<TokenResponse> RotateRefreshToken(string refreshToken)\n{\n    var tokenRequest = new Dictionary<string, string>\n    {\n        ["grant_type"] = "refresh_token",\n        ["refresh_token"] = refreshToken,\n        ["client_id"] = _configuration["OAuth:ClientId"],\n        ["client_secret"] = _configuration["OAuth:ClientSecret"]\n    };\n\n    using var client = new HttpClient();\n    var response = await client.PostAsync($"{_oauthAuthority}/oauth2/v2.0/token",\n        new FormUrlEncodedContent(tokenRequest));\n\n    if (response.IsSuccessStatusCode)\n    {\n        var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponse>();\n        return tokenResponse;\n    }\n\n    throw new SecurityException("Token rotation failed");\n}\n```\n\n### API Key Doğrulama\n\n#### 1. HMAC İmza Doğrulama\n```csharp\n// API key HMAC imza doğrulama\npublic bool ValidateApiKeySignature(string apiKey, string signature, string payload, string timestamp)\n{\n    try\n    {\n        // Timestamp kontrolü (5 dakika tolerans)\n        var requestTime = DateTimeOffset.FromUnixTimeSeconds(long.Parse(timestamp));\n        var currentTime = DateTimeOffset.UtcNow;\n\n        if (Math.Abs((currentTime - requestTime).TotalMinutes) > 5)\n            return false;\n\n        // HMAC-SHA256 imza oluştur\n        using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(apiKey));\n        var message = $"{payload}.{timestamp}";\n        var expectedSignature = Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(message)));\n\n        return CryptographicOperations.FixedTimeEquals(\n            Encoding.UTF8.GetBytes(signature),\n            Encoding.UTF8.GetBytes(expectedSignature));\n    }\n    catch\n    {\n        return false;\n    }\n}\n```\n\n#### 2. API Key Rate Limiting\n```csharp\n// API key rate limiting\npublic class ApiKeyRateLimiter\n{\n    private readonly ConcurrentDictionary<string, RateLimitInfo> _rateLimits = new();\n    private readonly int _maxRequestsPerHour = 1000;\n\n    public bool IsAllowed(string apiKey)\n    {\n        var now = DateTime.UtcNow;\n        var key = $"{apiKey}:{now.ToString("yyyy-MM-dd-HH")}";\n\n        var rateLimit = _rateLimits.GetOrAdd(key, _ => new RateLimitInfo\n        {\n            WindowStart = now,\n            RequestCount = 0\n        });\n\n        if ((now - rateLimit.WindowStart).TotalHours >= 1)\n        {\n            rateLimit.WindowStart = now;\n            rateLimit.RequestCount = 0;\n        }\n\n        if (rateLimit.RequestCount >= _maxRequestsPerHour)\n            return false;\n\n        rateLimit.RequestCount++;\n        return true;\n    }\n}\n```\n\n## 🔒 Güvenlik Konfigürasyonu\n\n### Environment Variables\n\n```bash\n# JWT Configuration\nJWT_SECRET_KEY=your-256-bit-secret-key-here\nJWT_ISSUER=https://your-app.com\nJWT_AUDIENCE=https://your-app.com\nJWT_EXPIRATION_MINUTES=1440\n\n# OAuth Configuration\nOAUTH_CLIENT_ID=your-oauth-client-id\nOAUTH_CLIENT_SECRET=your-oauth-client-secret\nOAUTH_AUTHORITY=https://login.microsoftonline.com/your-tenant-id\n\n# API Keys\nGOOGLE_MAPS_API_KEY=your-google-maps-api-key\nMAPBOX_ACCESS_TOKEN=your-mapbox-access-token\nHERE_API_KEY=your-here-api-key\n\n# Security Settings\nSECURITY_AUDIT_ENABLED=true\nSECURITY_REPORTS_PATH=security-reports\nSECURITY_SCORE_THRESHOLD=80\n```\n\n### appsettings.json Konfigürasyonu\n\n```json\n{\n  "Jwt": {\n    "SecretKey": "your-256-bit-secret-key-here",\n    "Issuer": "https://your-app.com",\n    "Audience": "https://your-app.com",\n    "ExpirationMinutes": 1440\n  },\n  "OAuth": {\n    "ClientId": "your-oauth-client-id",\n    "ClientSecret": "your-oauth-client-secret",\n    "Authority": "https://login.microsoftonline.com/your-tenant-id",\n    "RedirectUris": [\n      "https://your-app.com/auth/callback"\n    ]\n  },\n  "SecurityHeaders": {\n    "XContentTypeOptions": "nosniff",\n    "XFrameOptions": "DENY",\n    "XXSSProtection": "1; mode=block",\n    "StrictTransportSecurity": "max-age=31536000; includeSubDomains"\n  },\n  "Cors": {\n    "AllowedOrigins": [\n      "https://your-app.com",\n      "https://app.your-app.com"\n    ],\n    "AllowedHeaders": [\n      "Authorization",\n      "Content-Type",\n      "X-Requested-With"\n    ],\n    "AllowedMethods": [\n      "GET",\n      "POST",\n      "PUT",\n      "DELETE",\n      "OPTIONS"\n    ]\n  }\n}\n```\n\n## 🚨 Güvenlik Olayları ve Müdahale\n\n### Güvenlik İhlali Tespiti\n\n1. **Şüpheli Aktivite Tespiti**\n   - Çok sayıda başarısız giriş denemesi\n   - Anormal API kullanım paternleri\n   - Şüpheli IP adreslerinden gelen istekler\n\n2. **Otomatik Müdahale**\n   - Hesap geçici olarak kilitleme\n   - IP adresi bloklama\n   - Güvenlik olay loglama\n\n3. **Manuel İnceleme**\n   - Güvenlik loglarının analizi\n   - Kullanıcı davranış paternlerinin incelenmesi\n   - Sistem erişim loglarının kontrolü\n\n### Güvenlik Olay Müdahale Prosedürü\n\n```csharp\n// Güvenlik olay loglama\npublic async Task LogSecurityEvent(SecurityEvent securityEvent)\n{\n    var logEntry = new SecurityLogEntry\n    {\n        EventType = securityEvent.Type,\n        Severity = securityEvent.Severity,\n        UserId = securityEvent.UserId,\n        IpAddress = securityEvent.IpAddress,\n        UserAgent = securityEvent.UserAgent,\n        Details = securityEvent.Details,\n        Timestamp = DateTime.UtcNow\n    };\n\n    // Güvenlik olayını veritabanına kaydet\n    await _securityLogRepository.AddAsync(logEntry);\n\n    // Kritik olaylarda bildirim gönder\n    if (securityEvent.Severity == SecuritySeverity.Critical)\n    {\n        await _notificationService.SendSecurityAlert(logEntry);\n    }\n}\n```\n\n## 📊 Güvenlik İzleme ve Raporlama\n\n### Güvenlik Metrikleri\n\n- **Kimlik Doğrulama Başarı Oranı**: Başarılı/Toplam giriş denemeleri\n- **Token Geçerlilik Süresi**: Ortalama token kullanım süresi\n- **API Kullanım Paternleri**: Saatlik/daily API çağrı istatistikleri\n- **Güvenlik Olay Sayısı**: Günlük/haftalık güvenlik olay istatistikleri\n\n### Güvenlik Raporları\n\n```powershell\n# Güvenlik denetimi çalıştırma\n.\scripts\SecurityAudit.ps1 -EnableDetailedAudit -GenerateHtmlReport\n\n# Sonuçlar:\n# - security-reports/security-audit-summary.json\n# - security-reports/security-audit-report.html\n```\n\n## 🔄 Düzenli Güvenlik Kontrolleri\n\n### Haftalık Kontroller\n- [ ] Token expiration kontrolü\n- [ ] API key rotasyon kontrolü\n- [ ] Güvenlik log analizi\n- [ ] Bağımlılık güncellemeleri kontrolü\n\n### Aylık Kontroller\n- [ ] Tam güvenlik taraması\n- [ ] Penetration testing\n- [ ] Güvenlik politika güncellemeleri\n- [ ] Sertifika geçerlilik kontrolü\n\n### Yıllık Kontroller\n- [ ] Güvenlik mimarisi review\n- [ ] Üçüncü parti bağımlılık audit\n- [ ] Güvenlik eğitim güncellemeleri\n\n## 📞 İletişim ve Destek\n\nGüvenlik sorunları için:\n- **Email**: security@your-app.com\n- **Response Time**: Kritik sorunlar için 1 saat, diğerleri için 24 saat\n- **PGP Key**: Güvenlik raporları için şifreleme anahtarı\n\n## 📝 Değişiklik Geçmişi\n\n| Tarih | Sürüm | Değişiklik |\n|-------|--------|------------|\n| 2024-01-15 | 1.0 | İlk güvenlik politikası |\n| 2024-01-20 | 1.1 | JWT ve OAuth prosedürleri eklendi |\n| 2024-01-25 | 1.2 | API key doğrulama prosedürleri eklendi |\n| 2024-02-01 | 1.3 | Güvenlik olay müdahale prosedürleri eklendi |\n\n---\n\n**Son Güncelleme**: 2024-02-01\n**Sürüm**: 1.3\n**Doküment Sahibi**: Güvenlik Ekibi\n