# SECURITY.md

## GÃ¼venlik PolitikasÄ± ve ProsedÃ¼rleri

Bu dokÃ¼manda KesifUygulamasiTemplate projesinin gÃ¼venlik politikalarÄ±, token doÄŸrulama prosedÃ¼rleri ve gÃ¼venlik en iyi uygulamalarÄ± aÃ§Ä±klanmaktadÄ±r.

## ğŸ” GÃ¼venlik Genel BakÄ±ÅŸ

### Desteklenen Kimlik DoÄŸrulama TÃ¼rleri

1. **JWT (JSON Web Tokens)**
   - HS256 algoritmasÄ± ile imzalanmÄ±ÅŸ token'lar
   - 24 saatlik maksimum geÃ§erlilik sÃ¼resi
   - Zorunlu claim'ler: `iss`, `aud`, `exp`, `iat`, `sub`

2. **OAuth 2.0**
   - Authorization Code Grant akÄ±ÅŸÄ±
   - PKCE (Proof Key for Code Exchange) desteÄŸi
   - Refresh token rotasyonu

3. **API Keys**
   - HMAC-SHA256 ile imzalanmÄ±ÅŸ istekler
   - Rate limiting ve kullanÄ±m takibi
   - DÃ¼zenli rotasyon politikasÄ±

## ğŸ›¡ï¸ Token DoÄŸrulama ProsedÃ¼rleri

### JWT Token DoÄŸrulama

#### 1. Token YapÄ±sÄ± KontrolÃ¼
```csharp
// JWT token yapÄ±sÄ± kontrolÃ¼
public bool ValidateJwtStructure(string token)
{
    try
    {
        var parts = token.Split('.');
        if (parts.Length != 3)
            return false;

        // Header, Payload ve Signature bÃ¶lÃ¼mlerinin base64url formatÄ±nda olduÄŸunu kontrol et
        foreach (var part in parts)
        {
            Convert.FromBase64String(part.Replace('-', '+').Replace('_', '/'));
        }

        return true;
    }
    catch
    {
        return false;
    }
}
```

#### 2. Token Ä°mza DoÄŸrulama
```csharp
// JWT imza doÄŸrulama
public bool ValidateJwtSignature(string token, string secretKey)
{
    try
    {
        var tokenHandler = new JwtSecurityTokenHandler();
        var validationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = _configuration["Jwt:Issuer"],
            ValidAudience = _configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey)),
            ClockSkew = TimeSpan.Zero
        };

        tokenHandler.ValidateToken(token, validationParameters, out _);
        return true;
    }
    catch
    {
        return false;
    }
}
```

#### 3. Token Claim DoÄŸrulama
```csharp
// JWT claim doÄŸrulama
public bool ValidateJwtClaims(JwtSecurityToken jwtToken)
{
    // Zorunlu claim'leri kontrol et
    if (string.IsNullOrEmpty(jwtToken.Issuer))
        return false;

    if (string.IsNullOrEmpty(jwtToken.Audience))
        return false;

    if (jwtToken.ValidTo < DateTime.UtcNow)
        return false;

    // Ã–zel claim'leri kontrol et
    var userId = jwtToken.Claims.FirstOrDefault(c => c.Type == "userId")?.Value;
    if (string.IsNullOrEmpty(userId))
        return false;

    var role = jwtToken.Claims.FirstOrDefault(c => c.Type == "role")?.Value;
    if (string.IsNullOrEmpty(role))
        return false;

    return true;
}
```

### OAuth Token DoÄŸrulama

#### 1. Access Token DoÄŸrulama
```csharp
// OAuth access token doÄŸrulama
public async Task<bool> ValidateOAuthToken(string accessToken)
{
    try
    {
        using var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, $"{_oauthAuthority}/oauth2/v2.0/token");
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);

        var response = await client.SendAsync(request);
        return response.IsSuccessStatusCode;
    }
    catch
    {
        return false;
    }
}
```

#### 2. Refresh Token Rotasyonu
```csharp
// Refresh token rotasyonu
public async Task<TokenResponse> RotateRefreshToken(string refreshToken)
{
    var tokenRequest = new Dictionary<string, string>
    {
        ["grant_type"] = "refresh_token",
        ["refresh_token"] = refreshToken,
        ["client_id"] = _configuration["OAuth:ClientId"],
        ["client_secret"] = _configuration["OAuth:ClientSecret"]
    };

    using var client = new HttpClient();
    var response = await client.PostAsync($"{_oauthAuthority}/oauth2/v2.0/token",
        new FormUrlEncodedContent(tokenRequest));

    if (response.IsSuccessStatusCode)
    {
        var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponse>();
        return tokenResponse;
    }

    throw new SecurityException("Token rotation failed");
}
```

### API Key DoÄŸrulama

#### 1. HMAC Ä°mza DoÄŸrulama
```csharp
// API key HMAC imza doÄŸrulama
public bool ValidateApiKeySignature(string apiKey, string signature, string payload, string timestamp)
{
    try
    {
        // Timestamp kontrolÃ¼ (5 dakika tolerans)
        var requestTime = DateTimeOffset.FromUnixTimeSeconds(long.Parse(timestamp));
        var currentTime = DateTimeOffset.UtcNow;

        if (Math.Abs((currentTime - requestTime).TotalMinutes) > 5)
            return false;

        // HMAC-SHA256 imza oluÅŸtur
        using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(apiKey));
        var message = $"{payload}.{timestamp}";
        var expectedSignature = Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(message)));

        return CryptographicOperations.FixedTimeEquals(
            Encoding.UTF8.GetBytes(signature),
            Encoding.UTF8.GetBytes(expectedSignature));
    }
    catch
    {
        return false;
    }
}
```

#### 2. API Key Rate Limiting
```csharp
// API key rate limiting
public class ApiKeyRateLimiter
{
    private readonly ConcurrentDictionary<string, RateLimitInfo> _rateLimits = new();
    private readonly int _maxRequestsPerHour = 1000;

    public bool IsAllowed(string apiKey)
    {
        var now = DateTime.UtcNow;
        var key = $"{apiKey}:{now.ToString("yyyy-MM-dd-HH")}";

        var rateLimit = _rateLimits.GetOrAdd(key, _ => new RateLimitInfo
        {
            WindowStart = now,
            RequestCount = 0
        });

        if ((now - rateLimit.WindowStart).TotalHours >= 1)
        {
            rateLimit.WindowStart = now;
            rateLimit.RequestCount = 0;
        }

        if (rateLimit.RequestCount >= _maxRequestsPerHour)
            return false;

        rateLimit.RequestCount++;
        return true;
    }
}
```

## ğŸ”’ GÃ¼venlik KonfigÃ¼rasyonu

### Environment Variables

```bash
# JWT Configuration
JWT_SECRET_KEY=your-256-bit-secret-key-here
JWT_ISSUER=https://your-app.com
JWT_AUDIENCE=https://your-app.com
JWT_EXPIRATION_MINUTES=1440

# OAuth Configuration
OAUTH_CLIENT_ID=your-oauth-client-id
OAUTH_CLIENT_SECRET=your-oauth-client-secret
OAUTH_AUTHORITY=https://login.microsoftonline.com/your-tenant-id

# API Keys
GOOGLE_MAPS_API_KEY=your-google-maps-api-key
MAPBOX_ACCESS_TOKEN=your-mapbox-access-token
HERE_API_KEY=your-here-api-key

# Security Settings
SECURITY_AUDIT_ENABLED=true
SECURITY_REPORTS_PATH=security-reports
SECURITY_SCORE_THRESHOLD=80
```

### appsettings.json KonfigÃ¼rasyonu

```json
{
  "Jwt": {
    "SecretKey": "your-256-bit-secret-key-here",
    "Issuer": "https://your-app.com",
    "Audience": "https://your-app.com",
    "ExpirationMinutes": 1440
  },
  "OAuth": {
    "ClientId": "your-oauth-client-id",
    "ClientSecret": "your-oauth-client-secret",
    "Authority": "https://login.microsoftonline.com/your-tenant-id",
    "RedirectUris": [
      "https://your-app.com/auth/callback"
    ]
  },
  "SecurityHeaders": {
    "XContentTypeOptions": "nosniff",
    "XFrameOptions": "DENY",
    "XXSSProtection": "1; mode=block",
    "StrictTransportSecurity": "max-age=31536000; includeSubDomains"
  },
  "Cors": {
    "AllowedOrigins": [
      "https://your-app.com",
      "https://app.your-app.com"
    ],
    "AllowedHeaders": [
      "Authorization",
      "Content-Type",
      "X-Requested-With"
    ],
    "AllowedMethods": [
      "GET",
      "POST",
      "PUT",
      "DELETE",
      "OPTIONS"
    ]
  }
}
```

## ğŸš¨ GÃ¼venlik OlaylarÄ± ve MÃ¼dahale

### GÃ¼venlik Ä°hlali Tespiti

1. **ÅÃ¼pheli Aktivite Tespiti**
   - Ã‡ok sayÄ±da baÅŸarÄ±sÄ±z giriÅŸ denemesi
   - Anormal API kullanÄ±m paternleri
   - ÅÃ¼pheli IP adreslerinden gelen istekler

2. **Otomatik MÃ¼dahale**
   - Hesap geÃ§ici olarak kilitleme
   - IP adresi bloklama
   - GÃ¼venlik olay loglama

3. **Manuel Ä°nceleme**
   - GÃ¼venlik loglarÄ±nÄ±n analizi
   - KullanÄ±cÄ± davranÄ±ÅŸ paternlerinin incelenmesi
   - Sistem eriÅŸim loglarÄ±nÄ±n kontrolÃ¼

### GÃ¼venlik Olay MÃ¼dahale ProsedÃ¼rÃ¼

```csharp
// GÃ¼venlik olay loglama
public async Task LogSecurityEvent(SecurityEvent securityEvent)
{
    var logEntry = new SecurityLogEntry
    {
        EventType = securityEvent.Type,
        Severity = securityEvent.Severity,
        UserId = securityEvent.UserId,
        IpAddress = securityEvent.IpAddress,
        UserAgent = securityEvent.UserAgent,
        Details = securityEvent.Details,
        Timestamp = DateTime.UtcNow
    };

    // GÃ¼venlik olayÄ±nÄ± veritabanÄ±na kaydet
    await _securityLogRepository.AddAsync(logEntry);

    // Kritik olaylarda bildirim gÃ¶nder
    if (securityEvent.Severity == SecuritySeverity.Critical)
    {
        await _notificationService.SendSecurityAlert(logEntry);
    }
}
```

## ğŸ“Š GÃ¼venlik Ä°zleme ve Raporlama

### GÃ¼venlik Metrikleri

- **Kimlik DoÄŸrulama BaÅŸarÄ± OranÄ±**: BaÅŸarÄ±lÄ±/Toplam giriÅŸ denemeleri
- **Token GeÃ§erlilik SÃ¼resi**: Ortalama token kullanÄ±m sÃ¼resi
- **API KullanÄ±m Paternleri**: Saatlik/daily API Ã§aÄŸrÄ± istatistikleri
- **GÃ¼venlik Olay SayÄ±sÄ±**: GÃ¼nlÃ¼k/haftalÄ±k gÃ¼venlik olay istatistikleri

### GÃ¼venlik RaporlarÄ±

```powershell
# GÃ¼venlik denetimi Ã§alÄ±ÅŸtÄ±rma
.\scripts\SecurityAudit.ps1 -EnableDetailedAudit -GenerateHtmlReport

# SonuÃ§lar:
# - security-reports/security-audit-summary.json
# - security-reports/security-audit-report.html
```

## ğŸ”„ DÃ¼zenli GÃ¼venlik Kontrolleri

### HaftalÄ±k Kontroller
- [ ] Token expiration kontrolÃ¼
- [ ] API key rotasyon kontrolÃ¼
- [ ] GÃ¼venlik log analizi
- [ ] BaÄŸÄ±mlÄ±lÄ±k gÃ¼ncellemeleri kontrolÃ¼

### AylÄ±k Kontroller
- [ ] Tam gÃ¼venlik taramasÄ±
- [ ] Penetration testing
- [ ] GÃ¼venlik politika gÃ¼ncellemeleri
- [ ] Sertifika geÃ§erlilik kontrolÃ¼

### YÄ±llÄ±k Kontroller
- [ ] GÃ¼venlik mimarisi review
- [ ] ÃœÃ§Ã¼ncÃ¼ parti baÄŸÄ±mlÄ±lÄ±k audit
- [ ] GÃ¼venlik eÄŸitim gÃ¼ncellemeleri

## ğŸ“ Ä°letiÅŸim ve Destek

GÃ¼venlik sorunlarÄ± iÃ§in:
- **Email**: security@your-app.com
- **Response Time**: Kritik sorunlar iÃ§in 1 saat, diÄŸerleri iÃ§in 24 saat
- **PGP Key**: GÃ¼venlik raporlarÄ± iÃ§in ÅŸifreleme anahtarÄ±

## ğŸ“ DeÄŸiÅŸiklik GeÃ§miÅŸi

| Tarih | SÃ¼rÃ¼m | DeÄŸiÅŸiklik |
|-------|--------|------------|
| 2024-01-15 | 1.0 | Ä°lk gÃ¼venlik politikasÄ± |
| 2024-01-20 | 1.1 | JWT ve OAuth prosedÃ¼rleri eklendi |
| 2024-01-25 | 1.2 | API key doÄŸrulama prosedÃ¼rleri eklendi |
| 2024-02-01 | 1.3 | GÃ¼venlik olay mÃ¼dahale prosedÃ¼rleri eklendi |

---

**Son GÃ¼ncelleme**: 2024-02-01
**SÃ¼rÃ¼m**: 1.3
**DokÃ¼ment Sahibi**: GÃ¼venlik Ekibi
