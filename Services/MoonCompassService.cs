using System;\nusing System.Threading.Tasks;\nusing CoordinateSharp;\nusing KesifUygulamasiTemplate.Models;\n\nnamespace KesifUygulamasiTemplate.Services\n{\n    public class MoonCompassService : IMoonCompassService\n    {\n        private readonly DatabaseService _databaseService;\n        private readonly ConnectivityService _connectivityService;\n\n        public MoonCompassService(DatabaseService databaseService, ConnectivityService connectivityService)\n        {\n            _databaseService = databaseService;\n            _connectivityService = connectivityService;\n        }\n\n        public async Task<MoonData> GetMoonDataAsync(double latitude, double longitude)\n        {\n            var today = DateTime.Now.Date;\n\n            // Offline öncelik: önbellekten kontrol et\n            if (!_connectivityService.IsConnected)\n            {\n                var cached = await _databaseService.GetMoonDataAsync(latitude, longitude, today);\n                if (cached != null)\n                    return cached;\n            }\n\n            // CoordinateSharp ile hesaplama yap\n            var coordinate = new Coordinate(latitude, longitude, DateTime.Now);\n\n            var moonData = new MoonData\n            {\n                Id = 0,\n                Latitude = latitude,\n                Longitude = longitude,\n                Date = today,\n                RiseTime = coordinate.CelestialInfo.MoonRise ?? DateTime.MinValue,\n                SetTime = coordinate.CelestialInfo.MoonSet ?? DateTime.MinValue,\n                Phase = coordinate.CelestialInfo.MoonIllum.Fraction,\n                Azimuth = coordinate.CelestialInfo.MoonAzimuth,\n                Altitude = coordinate.CelestialInfo.MoonAltitude,\n                PhaseName = GetMoonPhaseName(coordinate.CelestialInfo.MoonIllum.PhaseName.ToString()),\n                Illumination = coordinate.CelestialInfo.MoonIllum.Fraction,\n                Distance = coordinate.CelestialInfo.MoonDistance.Kilometers\n            };\n\n            // Önbelleğe kaydet\n            try\n            {\n                await _databaseService.InsertMoonDataAsync(moonData);\n            }\n            catch\n            {\n                // Önbellek hatası kritik değil\n            }\n\n            return moonData;\n        }\n\n        private string GetMoonPhaseName(string phaseName)\n        {\n            return phaseName switch\n            {\n                "New Moon" => "Yeni Ay",\n                "Waxing Crescent" => "Hilal",\n                "First Quarter" => "İlk Dördün",\n                "Waxing Gibbous" => "Şişkin Ay",\n                "Full Moon" => "Dolunay",\n                "Waning Gibbous" => "Azalan Şişkin",\n                "Third Quarter" => "Son Dördün",\n                "Waning Crescent" => "Azalan Hilal",\n                _ => "Bilinmeyen"\n            };\n        }\n    }\n}\n