name: .NET MAUI CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PACKAGE_NAME: 'com.vahit.kesifuygulamasi'
    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Version bump iÃ§in gerekli
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2) Setup .NET 8 with v3 (DÃœZELTME: setup-dotnet)
      - name: Setup .NET 8
        uses: actions/setup-dotenv@v3
        with:
          dotnet-version: '8.0.x'

      # 3) Install Android workload
      - name: Install Android workload
        run: dotnet workload install android

      # 4) Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 5) Build and Create Android .aab using msbuild Bundle target
      - name: Make Android AAB build script executable
        run: chmod +x scripts/build-android-aab.sh

      - name: Build Android AAB with msbuild Bundle
        id: build_aab
        run: ./scripts/build-android-aab.sh | tee build.log

      # 6) Run tests
      - name: Run Tests
        run: dotnet test KesifUygulamasiTemplate.Tests/KesifUygulamasiTemplate.Tests.csproj --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" | tee test.log

      # 7) Upload artifacts: .aab from artifacts/, test results, build logs
      - name: Upload AAB Artifacts
        if: steps.build_aab.outputs.primary_aab != ''
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: ./artifacts/*.aab

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/test-results.trx
            **/TestResults/*.xml
            test.log

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log

      # 8) Version bump (patch) - sadece baÅŸarÄ±lÄ± build sonrasÄ± ve main branch
      - name: Make version bump script executable
        if: github.ref == 'refs/heads/main' && success()
        run: chmod +x scripts/version-bump.sh

      - name: Version Bump (patch)
        if: github.ref == 'refs/heads/main' && success()
        id: version_bump
        run: ./scripts/version-bump.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9) Secret kontrolÃ¼ ve deploy uyarÄ±sÄ±
      - name: Check Google Play Service Account Secret
        if: github.ref == 'refs/heads/main' && success()
        id: check_secret
        run: |
          if [ -z "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}" ]; then
            echo "secret_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::GOOGLE_PLAY_SERVICE_ACCOUNT secret bulunamadÄ±!"
            echo "::warning::Google Play Store deploy atlanacak."
            echo "::warning::Deploy yapmak iÃ§in repo Settings > Secrets'a GOOGLE_PLAY_SERVICE_ACCOUNT ekleyin."
          else
            echo "secret_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… GOOGLE_PLAY_SERVICE_ACCOUNT secret mevcut, deploy yapÄ±lacak."
          fi

      # 10) Deploy to Google Play - sadece secret varsa ve main branch'te
      - name: Deploy to Google Play
        if: github.ref == 'refs/heads/main' && success() && steps.check_secret.outputs.secret_exists == 'true'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: ${{ env.PACKAGE_NAME || 'com.vahit.kesifuygulamasi' }}
          releaseFiles: ./artifacts/*.aab
          track: internal
          status: completed
          changesNotSentForReview: true

      # Secret eksikse deploy uyarÄ±sÄ±
      - name: Deploy Skipped Warning
        if: github.ref == 'refs/heads/main' && success() && steps.check_secret.outputs.secret_exists == 'false'
        run: |
          echo "âš ï¸ Deploy atlandÄ±: GOOGLE_PLAY_SERVICE_ACCOUNT secret eksik"
          echo "::notice::Google Play Store'a deploy yapmak iÃ§in:"
          echo "::notice::1. Google Play Console'da Service Account oluÅŸturun"
          echo "::notice::2. JSON anahtarÄ±nÄ± indirin"
          echo "::notice::3. GitHub repo Settings > Secrets and variables > Actions"
          echo "::notice::4. GOOGLE_PLAY_SERVICE_ACCOUNT adÄ±yla secret ekleyin"

      # Error notification
      - name: Notify on Failure
        if: failure()
        run: |
          echo "::error::Build, test veya deploy baÅŸarÄ±sÄ±z! Artifact'leri kontrol edin:"
          echo "::error::- android-aab: AAB dosyasÄ± (./artifacts/ iÃ§inde)"
          echo "::error::- test-results: Test sonuÃ§larÄ± ve loglarÄ±"
          echo "::error::- build-logs: Build detaylarÄ±"

      # Success notification
      - name: Notify on Success
        if: github.ref == 'refs/heads/main' && success()
        run: |
          echo "âœ… Pipeline baÅŸarÄ±yla tamamlandÄ±!"
          echo "ğŸ“¦ AAB dosyasÄ± sayÄ±sÄ±: ${{ steps.build_aab.outputs.aab_count }}"
          echo "ğŸ“ Artifacts klasÃ¶rÃ¼: ${{ steps.build_aab.outputs.artifacts_dir }}"
          echo "ğŸ¯ Ana AAB dosyasÄ±: ${{ steps.build_aab.outputs.primary_aab }}"
          if [ -n "${{ steps.version_bump.outputs.new_version }}" ]; then
            echo "ğŸš€ Yeni version: ${{ steps.version_bump.outputs.new_version }}"
            echo "ğŸ·ï¸  Yeni tag: ${{ steps.version_bump.outputs.tag_name }}"
          fi
          if [ "${{ steps.check_secret.outputs.secret_exists }}" == "true" ]; then
            echo "ğŸ“± Google Play Store deploy baÅŸarÄ±lÄ±!"
          else
            echo "âš ï¸ Google Play Store deploy atlandÄ± (secret eksik)"
          fi
