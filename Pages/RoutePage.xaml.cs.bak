using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Maps;
using Microsoft.Maui.Devices.Sensors;
using Microsoft.Maui.Maps;
using KesifUygulamasiTemplate.ViewModels;
using KesifUygulamasiTemplate.Services.Interfaces;

namespace KesifUygulamasiTemplate.Pages
{
    public partial class RoutePage : ContentPage
    {
        private readonly RouteViewModel _viewModel;
        private Polyline _routeLine;

        public RoutePage(IRouteService routeService, ITrafficService trafficService)
        {
            InitializeComponent();
            _viewModel = new RouteViewModel(routeService, trafficService);
            BindingContext = _viewModel;
            _viewModel.PropertyChanged += ViewModel_PropertyChanged;
        }

        protected override void OnAppearing()
        {
            base.OnAppearing();
            // Varsay�lan ba�lang��/var�� de�erleri
            StartEntry.Text = "39.9,32.8";
        }

        protected override void OnDisappearing()
        {
            base.OnDisappearing();
            // Temizleme i�lemleri
            _viewModel.PropertyChanged -= ViewModel_PropertyChanged;
        }

        private void ViewModel_PropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)
        {
            if (e.PropertyName == nameof(_viewModel.RoutePoints))
            {
                DrawRoute();
            }
        }

        private void DrawRoute()
        {
            if (_routeLine != null)
                RouteMap.MapElements.Remove(_routeLine);

            if (_viewModel.RoutePoints.Count < 2)
                return;

            _routeLine = new Polyline
            {
                StrokeColor = Colors.Blue,
                StrokeWidth = 4
            };

            foreach (var loc in _viewModel.RoutePoints)
                _routeLine.Geopath.Add(new Location(loc.Latitude, loc.Longitude));

            RouteMap.MapElements.Add(_routeLine);

            // Haritay� rotan�n ortas�na odakla
            var center = _viewModel.RoutePoints[_viewModel.RoutePoints.Count / 2];
            RouteMap.MoveToRegion(MapSpan.FromCenterAndRadius(
                new Location(center.Latitude, center.Longitude),
                Distance.FromKilometers(20)));
        }
    }
}
