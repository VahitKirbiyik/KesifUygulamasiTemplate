# Test-IncidentLogging.ps1 - Realtime incident logging test scripti
# CI/CD pipeline ile entegre edilmiÅŸ olay loglama test sistemi

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose,
    [switch]$ExportJson,
    [string]$LogPath = "logs\incidents",
    [int]$TestDurationMinutes = 5,
    [int]$IncidentCount = 50
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler
$testResults = @{
    TotalTests = 0
    PassedTests = 0
    FailedTests = 0
    TestDuration = [TimeSpan]::Zero
    Details = @()
    IncidentStats = @{
        LoggedIncidents = 0
        CriticalCount = 0
        ErrorCount = 0
        WarningCount = 0
        InfoCount = 0
    }
}

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:INCIDENT_LOG_PATH = $LogPath
$env:ENABLE_REALTIME_LOGGING = "true"
$env:MAX_LOG_FILE_SIZE_MB = "10"
$env:LOG_RETENTION_DAYS = "7"

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "      ğŸš¨ Incident Logging Test Sistemi" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# Test fonksiyonlarÄ±
function Test-IncidentLogging {
    param(
        [string]$TestName,
        [scriptblock]$TestScript
    )

    $startTime = Get-Date
    $testPassed = $false
    $errorMessage = ""

    Write-ColorOutput "ğŸ§ª $TestName testi baÅŸlatÄ±lÄ±yor..." "White"

    try {
        & $TestScript
        $testPassed = $true
        Write-ColorOutput "  âœ… $TestName testi baÅŸarÄ±lÄ±" "Green"
    } catch {
        $errorMessage = $_.Exception.Message
        Write-ColorOutput "  âŒ $TestName testi baÅŸarÄ±sÄ±z: $errorMessage" "Red"
    } finally {
        $endTime = Get-Date
        $duration = $endTime - $startTime

        $testResults.TotalTests++
        if ($testPassed) {
            $testResults.PassedTests++
        } else {
            $testResults.FailedTests++
        }
        $testResults.TestDuration += $duration

        $testResults.Details += @{
            TestName = $TestName
            Passed = $testPassed
            Duration = $duration
            ErrorMessage = $errorMessage
        }
    }
}

# Log klasÃ¶rÃ¼ oluÅŸturma testi
function Test-LogDirectoryCreation {
    Write-ColorOutput "  ğŸ“ Log klasÃ¶rÃ¼ oluÅŸturma kontrol ediliyor..." "Gray"

    $fullLogPath = Join-Path $ProjectPath $LogPath

    if (!(Test-Path $fullLogPath)) {
        Write-ColorOutput "    ğŸ“‚ Log klasÃ¶rÃ¼ oluÅŸturuluyor: $fullLogPath" "Gray"
        New-Item -ItemType Directory -Path $fullLogPath -Force | Out-Null
    } else {
        Write-ColorOutput "    âœ… Log klasÃ¶rÃ¼ mevcut: $fullLogPath" "Green"
    }

    # Test log dosyasÄ± oluÅŸtur
    $testFile = Join-Path $fullLogPath "test-log.json"
    $testData = @{
        test = "Incident logging test"
        timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
    }
    $testData | ConvertTo-Json | Set-Content $testFile

    if (Test-Path $testFile) {
        Write-ColorOutput "    âœ… Test log dosyasÄ± oluÅŸturuldu" "Green"
        Remove-Item $testFile -Force
    } else {
        Write-ColorOutput "    âŒ Test log dosyasÄ± oluÅŸturulamadÄ±" "Red"
        throw "Log directory creation failed"
    }
}

# FarklÄ± seviye olay loglama testi
function Test-IncidentLevelLogging {
    Write-ColorOutput "  ğŸ“Š FarklÄ± seviye olay loglama test ediliyor..." "Gray"

    $fullLogPath = Join-Path $ProjectPath $LogPath
    $testFile = Join-Path $fullLogPath "test-incidents.json"

    # Test olaylarÄ±
    $testIncidents = @(
        @{
            Level = "Critical"
            Message = "Critical system failure detected"
            Category = "System"
        },
        @{
            Level = "Error"
            Message = "Database connection failed"
            Category = "Database"
        },
        @{
            Level = "Warning"
            Message = "High memory usage detected"
            Category = "Performance"
        },
        @{
            Level = "Info"
            Message = "User login successful"
            Category = "Authentication"
        }
    )

    $loggedIncidents = @()

    foreach ($incident in $testIncidents) {
        $logEntry = @{
            Id = [Guid]::NewGuid().ToString()
            Level = $incident.Level
            Message = $incident.Message
            Category = $incident.Category
            Timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            Environment = $TestEnvironment
            Metadata = @{
                TestRun = $true
                Source = "Test-IncidentLogging.ps1"
            }
            Source = "KesifUygulamasiTemplate"
        }

        $loggedIncidents += $logEntry

        # Ä°statistikleri gÃ¼ncelle
        switch ($incident.Level) {
            "Critical" { $testResults.IncidentStats.CriticalCount++ }
            "Error" { $testResults.IncidentStats.ErrorCount++ }
            "Warning" { $testResults.IncidentStats.WarningCount++ }
            "Info" { $testResults.IncidentStats.InfoCount++ }
        }
        $testResults.IncidentStats.LoggedIncidents++
    }

    # JSON dosyasÄ±na yaz
    $loggedIncidents | ConvertTo-Json -Depth 10 | Set-Content $testFile

    Write-ColorOutput "    ğŸ“ $($testIncidents.Count) test olayÄ± loglandÄ±" "Gray"
    Write-ColorOutput "    ğŸ“Š Critical: $($testResults.IncidentStats.CriticalCount), Error: $($testResults.IncidentStats.ErrorCount), Warning: $($testResults.IncidentStats.WarningCount), Info: $($testResults.IncidentStats.InfoCount)" "Gray"

    if ($testResults.IncidentStats.LoggedIncidents -eq $testIncidents.Count) {
        Write-ColorOutput "    âœ… TÃ¼m olay seviyeleri baÅŸarÄ±yla loglandÄ±" "Green"
    } else {
        Write-ColorOutput "    âŒ Olay loglama sayÄ±sÄ± uyumsuz" "Red"
        throw "Incident level logging count mismatch"
    }
}

# Log dosya rotasyonu testi
function Test-LogRotation {
    Write-ColorOutput "  ğŸ”„ Log dosya rotasyonu test ediliyor..." "Gray"

    $fullLogPath = Join-Path $ProjectPath $LogPath

    # BÃ¼yÃ¼k log dosyasÄ± oluÅŸtur (test iÃ§in)
    $largeLogFile = Join-Path $fullLogPath "large-test-log.json"
    $largeContent = @()

    for ($i = 1; $i -le 1000; $i++) {
        $largeContent += @{
            Id = [Guid]::NewGuid().ToString()
            Level = "Info"
            Message = "Test log entry $i with some additional content to make it larger"
            Category = "Test"
            Timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            Environment = $TestEnvironment
        }
    }

    $largeContent | ConvertTo-Json -Depth 10 | Set-Content $largeLogFile

    $fileSize = (Get-Item $largeLogFile).Length
    $fileSizeMB = [math]::Round($fileSize / 1MB, 2)

    Write-ColorOutput "    ğŸ“„ BÃ¼yÃ¼k test dosyasÄ± oluÅŸturuldu: $fileSizeMB MB" "Gray"

    # Dosya boyutu kontrolÃ¼
    $maxSizeMB = [int]$env:MAX_LOG_FILE_SIZE_MB
    if ($fileSizeMB -gt $maxSizeMB) {
        Write-ColorOutput "    âœ… Dosya boyutu rotasyon eÅŸiÄŸini aÅŸtÄ± ($maxSizeMB MB)" "Green"
    } else {
        Write-ColorOutput "    âš ï¸  Dosya boyutu rotasyon eÅŸiÄŸinin altÄ±nda" "Yellow"
    }

    # Temizlik
    Remove-Item $largeLogFile -Force
}

# Log temizleme testi
function Test-LogCleanup {
    Write-ColorOutput "  ğŸ§¹ Log temizleme testi baÅŸlatÄ±lÄ±yor..." "Gray"

    $fullLogPath = Join-Path $ProjectPath $LogPath

    # Eski test dosyalarÄ± oluÅŸtur
    $oldDate = (Get-Date).AddDays(-($env:LOG_RETENTION_DAYS + 1))
    $oldFileName = "incident-$($oldDate.ToString('yyyy-MM-dd'))-test.json"
    $oldFilePath = Join-Path $fullLogPath $oldFileName

    @{ test = "old file" } | ConvertTo-Json | Set-Content $oldFilePath
    (Get-Item $oldFilePath).CreationTime = $oldDate

    Write-ColorOutput "    ğŸ“… Eski test dosyasÄ± oluÅŸturuldu: $oldFileName" "Gray"

    # Yeni dosya oluÅŸtur
    $newFileName = "incident-$((Get-Date).ToString('yyyy-MM-dd'))-test.json"
    $newFilePath = Join-Path $fullLogPath $newFileName
    @{ test = "new file" } | ConvertTo-Json | Set-Content $newFilePath

    Write-ColorOutput "    ğŸ“… Yeni test dosyasÄ± oluÅŸturuldu: $newFileName" "Gray"

    # Eski dosyalarÄ±n temizlenmesi simÃ¼lasyonu
    $retentionDays = [int]$env:LOG_RETENTION_DAYS
    $cutoffDate = (Get-Date).AddDays(-$retentionDays)

    $oldFiles = Get-ChildItem $fullLogPath -Filter "incident-*.json" |
        Where-Object { $_.CreationTime -lt $cutoffDate }

    Write-ColorOutput "    ğŸ—‘ï¸  Temizlenecek eski dosyalar: $($oldFiles.Count)" "Gray"

    foreach ($file in $oldFiles) {
        Remove-Item $file.FullName -Force
        Write-ColorOutput "    âœ… Eski dosya silindi: $($file.Name)" "Green"
    }

    # Temizlik sonrasÄ± kontrol
    $remainingFiles = Get-ChildItem $fullLogPath -Filter "incident-*.json"
    Write-ColorOutput "    ğŸ“Š Kalan dosya sayÄ±sÄ±: $($remainingFiles.Count)" "Gray"
}

# Performans testi
function Test-IncidentLoggingPerformance {
    Write-ColorOutput "  âš¡ Incident logging performans testi baÅŸlatÄ±lÄ±yor..." "Gray"

    $fullLogPath = Join-Path $ProjectPath $LogPath
    $perfTestFile = Join-Path $fullLogPath "performance-test.json"

    $startTime = Get-Date
    $testIncidents = @()

    # Ã‡ok sayÄ±da olay oluÅŸtur
    for ($i = 1; $i -le $IncidentCount; $i++) {
        $testIncidents += @{
            Id = [Guid]::NewGuid().ToString()
            Level = "Info"
            Message = "Performance test incident $i"
            Category = "Performance"
            Timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            Environment = $TestEnvironment
            Metadata = @{
                TestNumber = $i
                PerformanceTest = $true
            }
        }
    }

    $testIncidents | ConvertTo-Json -Depth 10 | Set-Content $perfTestFile

    $endTime = Get-Date
    $duration = $endTime - $startTime
    $avgTimePerIncident = $duration.TotalMilliseconds / $IncidentCount

    Write-ColorOutput "    ğŸ“ˆ $IncidentCount olay loglandÄ±" "Gray"
    Write-ColorOutput "    â±ï¸  Toplam sÃ¼re: $([math]::Round($duration.TotalSeconds, 2)) saniye" "Gray"
    Write-ColorOutput "    ğŸ“Š Olay baÅŸÄ±na ortalama sÃ¼re: $([math]::Round($avgTimePerIncident, 2)) ms" "Gray"

    if ($avgTimePerIncident -lt 10) { # 10ms'den az
        Write-ColorOutput "    âœ… Performans kabul edilebilir" "Green"
    } else {
        Write-ColorOutput "    âš ï¸  Performans iyileÅŸtirilebilir" "Yellow"
    }

    # Temizlik
    Remove-Item $perfTestFile -Force
}

# Ana test dÃ¶ngÃ¼sÃ¼
Write-ColorOutput "ğŸš€ Incident logging testleri baÅŸlatÄ±lÄ±yor..." "White"
Write-ColorOutput ""

# Testleri Ã§alÄ±ÅŸtÄ±r
Test-IncidentLogging -TestName "Log KlasÃ¶rÃ¼ OluÅŸturma" -TestScript { Test-LogDirectoryCreation }
Test-IncidentLogging -TestName "FarklÄ± Seviye Olay Loglama" -TestScript { Test-IncidentLevelLogging }
Test-IncidentLogging -TestName "Log Dosya Rotasyonu" -TestScript { Test-LogRotation }
Test-IncidentLogging -TestName "Log Temizleme" -TestScript { Test-LogCleanup }
Test-IncidentLogging -TestName "Performans Testi" -TestScript { Test-IncidentLoggingPerformance }

# Test Ã¶zeti
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           ğŸ“Š Test SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$successRate = if ($testResults.TotalTests -gt 0) {
    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)
} else { 0 }

Write-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"
Write-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"
Write-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"
Write-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"
Write-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"

# Incident istatistikleri
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "        ğŸš¨ Incident Ä°statistikleri" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

Write-ColorOutput "Loglanan Toplam Olay: $($testResults.IncidentStats.LoggedIncidents)" "White"
Write-ColorOutput "Critical: $($testResults.IncidentStats.CriticalCount)" "Red"
Write-ColorOutput "Error: $($testResults.IncidentStats.ErrorCount)" "Red"
Write-ColorOutput "Warning: $($testResults.IncidentStats.WarningCount)" "Yellow"
Write-ColorOutput "Info: $($testResults.IncidentStats.InfoCount)" "Green"

# DetaylÄ± sonuÃ§lar
if ($Verbose) {
    Write-ColorOutput "" "White"
    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"
    foreach ($detail in $testResults.Details) {
        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }
        Write-ColorOutput "  $status $($detail.TestName)" "White"
        if (!$detail.Passed -and $detail.ErrorMessage) {
            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"
        }
    }
}

# JSON export
if ($ExportJson) {
    $jsonPath = Join-Path $ProjectPath "incident-logging-test-results.json"
    $exportData = @{
        metadata = @{
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            script_version = "1.0.0"
            test_environment = $TestEnvironment
            log_path = $LogPath
            total_duration_seconds = $testResults.TestDuration.TotalSeconds
            incident_count = $IncidentCount
        }
        summary = @{
            total_tests = $testResults.TotalTests
            passed_tests = $testResults.PassedTests
            failed_tests = $testResults.FailedTests
            success_rate = $successRate
        }
        incident_stats = $testResults.IncidentStats
        details = $testResults.Details
        recommendations = @(
            "Log rotasyonunu etkinleÅŸtir",
            "Eski log dosyalarÄ±nÄ± dÃ¼zenli temizle",
            "Performans monitoring'i aktif tut",
            "Critical olaylar iÃ§in alert sistemi kur",
            "Log analizi dashboard'u oluÅŸtur"
        )
    }

    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
    Write-ColorOutput "ğŸ“„ Test sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"
}

# Badge tetikleme
if ($testResults.PassedTests -gt 0) {
    Show-Badge "Incident-Tracked"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($testResults.FailedTests -eq 0) {
    Write-ColorOutput "ğŸ‰ Incident logging testleri baÅŸarÄ±lÄ±! Sistem hazÄ±r." "Green"
    exit 0
} else {
    Write-ColorOutput "ğŸ’¥ BazÄ± incident logging testleri baÅŸarÄ±sÄ±z oldu." "Red"
    exit 1
}

# Badge gÃ¶sterme fonksiyonu
function Show-Badge {
    param([string]$BadgeName)

    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"

    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)
    $badgeFile = Join-Path $ProjectPath "badge.json"
    if (Test-Path $badgeFile) {
        try {
            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json
            if ($badgeData.PSObject.Properties.Name -notcontains $BadgeName) {
                $badgeData | Add-Member -MemberType NoteProperty -Name $BadgeName -Value $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            } else {
                $badgeData.$BadgeName = $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            }
        } catch {
            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"
        }
    } else {
        # Yeni badge dosyasÄ± oluÅŸtur
        $newBadgeData = @{
            $BadgeName = $true
        }
        $newBadgeData | ConvertTo-Json | Set-Content $badgeFile
        Write-ColorOutput "  âœ… Yeni badge dosyasÄ± oluÅŸturuldu" "Green"
    }
}
