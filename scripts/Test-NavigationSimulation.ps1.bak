# Test-NavigationSimulation.ps1 - Offline navigation simÃ¼lasyon testi
# Bu script navigation simÃ¼lasyonunu test eder ve CI/CD pipeline ile entegre Ã§alÄ±ÅŸÄ±r

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose,
    [switch]$ExportJson,
    [int]$SimulationSpeed = 500,
    [string]$SimulationMode = "normal"
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler
$testResults = @{
    TotalTests = 0
    PassedTests = 0
    FailedTests = 0
    TestDuration = [TimeSpan]::Zero
    Details = @()
}

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:SIMULATION_SPEED = $SimulationSpeed.ToString()
$env:SIMULATION_MODE = $SimulationMode
$env:ENABLE_SIMULATION_LOGGING = if ($Verbose) { "true" } else { "false" }

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "      ğŸš— Navigation SimÃ¼lasyon Testi" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# Test fonksiyonlarÄ±
function Test-NavigationSimulation {
    param(
        [string]$TestName,
        [scriptblock]$TestScript
    )

    $startTime = Get-Date
    $testPassed = $false
    $errorMessage = ""

    Write-ColorOutput "ğŸ§ª $TestName testi baÅŸlatÄ±lÄ±yor..." "White"

    try {
        & $TestScript
        $testPassed = $true
        Write-ColorOutput "  âœ… $TestName testi baÅŸarÄ±lÄ±" "Green"
    } catch {
        $errorMessage = $_.Exception.Message
        Write-ColorOutput "  âŒ $TestName testi baÅŸarÄ±sÄ±z: $errorMessage" "Red"
    } finally {
        $endTime = Get-Date
        $duration = $endTime - $startTime

        $testResults.TotalTests++
        if ($testPassed) {
            $testResults.PassedTests++
        } else {
            $testResults.FailedTests++
        }
        $testResults.TestDuration += $duration

        $testResults.Details += @{
            TestName = $TestName
            Passed = $testPassed
            Duration = $duration
            ErrorMessage = $errorMessage
        }
    }
}

# GPS Mock Testi
function Test-GpsMock {
    Write-ColorOutput "  ğŸ“¡ GPS mock sistemi test ediliyor..." "Gray"

    # GPS konfigÃ¼rasyon dosyasÄ± kontrolÃ¼
    $gpsConfigPath = Join-Path $env:APPDATA "KesifUygulamasi\SimulationData\gps_config.json"
    $gpsConfigDir = Split-Path $gpsConfigPath -Parent

    if (!(Test-Path $gpsConfigDir)) {
        New-Item -ItemType Directory -Path $gpsConfigDir -Force | Out-Null
    }

    if (Test-Path $gpsConfigPath) {
        Write-ColorOutput "    âœ… GPS konfigÃ¼rasyon dosyasÄ± bulundu" "Green"
    } else {
        Write-ColorOutput "    âš ï¸  GPS konfigÃ¼rasyon dosyasÄ± bulunamadÄ±, oluÅŸturuluyor..." "Yellow"
        $gpsConfig = @{
            accuracy = 5.0
            update_interval = $SimulationSpeed
            mock_provider = "NavigationSimulator"
        } | ConvertTo-Json
        $gpsConfig | Out-File $gpsConfigPath -Encoding UTF8
    }
}

# Rota SimÃ¼lasyon Testi
function Test-RouteSimulation {
    Write-ColorOutput "  ğŸ—ºï¸  Rota simÃ¼lasyonu test ediliyor..." "Gray"

    # Ã–rnek rota oluÅŸtur
    $sampleRoute = @(
        @{ Lat = 41.0082; Lng = 28.9784 }, # Ä°stanbul
        @{ Lat = 41.0151; Lng = 28.9795 }, # ÅiÅŸli
        @{ Lat = 41.0222; Lng = 28.9855 }, # MecidiyekÃ¶y
        @{ Lat = 41.0292; Lng = 28.9915 }, # Levent
        @{ Lat = 41.0362; Lng = 28.9975 }  # 4. Levent
    )

    Write-ColorOutput "    ğŸ“ Ã–rnek rota oluÅŸturuldu: $($sampleRoute.Count) nokta" "Gray"

    # SimÃ¼lasyon hÄ±zÄ± testi
    $expectedDuration = ($sampleRoute.Count - 1) * $SimulationSpeed / 1000
    Write-ColorOutput "    â±ï¸  Beklenen simÃ¼lasyon sÃ¼resi: ${expectedDuration}s" "Gray"

    # SimÃ¼lasyon verisi kontrolÃ¼
    $simulationDataPath = Join-Path $env:APPDATA "KesifUygulamasi\SimulationData"
    if (Test-Path $simulationDataPath) {
        $simulationFiles = Get-ChildItem $simulationDataPath -Filter "simulation_*.json"
        Write-ColorOutput "    ğŸ“Š Ã–nceki simÃ¼lasyon dosyalarÄ±: $($simulationFiles.Count)" "Gray"
    }
}

# Rota SapmasÄ± Testi
function Test-RouteDeviation {
    Write-ColorOutput "  ğŸš¨ Rota sapmasÄ± simÃ¼lasyonu test ediliyor..." "Gray"

    if ($SimulationMode -eq "deviation_test") {
        Write-ColorOutput "    ğŸ”„ Sapma dÃ¼zeltme modu aktif" "Gray"
    } else {
        Write-ColorOutput "    ğŸ“ Normal rota modu" "Gray"
    }

    # Sapma algÄ±lama simÃ¼lasyonu
    $deviationThreshold = 0.001  # ~100 metre
    Write-ColorOutput "    ğŸ“ Sapma eÅŸiÄŸi: ${deviationThreshold} derece" "Gray"
}

# Offline Navigation Testi
function Test-OfflineNavigation {
    Write-ColorOutput "  ğŸ“± Offline navigation testi..." "Gray"

    # Offline veri kontrolÃ¼
    $offlineDataPath = Join-Path $ProjectPath "OfflineData"
    if (Test-Path $offlineDataPath) {
        $tileFiles = Get-ChildItem $offlineDataPath -Filter "*.png" -Recurse
        Write-ColorOutput "    ğŸ—ºï¸  Offline tile dosyalarÄ±: $($tileFiles.Count)" "Gray"
    } else {
        Write-ColorOutput "    âš ï¸  Offline veri klasÃ¶rÃ¼ bulunamadÄ±" "Yellow"
    }
}

# Ana test dÃ¶ngÃ¼sÃ¼
Write-ColorOutput "ğŸš€ Navigation simÃ¼lasyon testleri baÅŸlatÄ±lÄ±yor..." "White"
Write-ColorOutput ""

# Testleri Ã§alÄ±ÅŸtÄ±r
Test-NavigationSimulation -TestName "GPS Mock Sistemi" -TestScript { Test-GpsMock }
Test-NavigationSimulation -TestName "Rota SimÃ¼lasyonu" -TestScript { Test-RouteSimulation }
Test-NavigationSimulation -TestName "Rota SapmasÄ±" -TestScript { Test-RouteDeviation }
Test-NavigationSimulation -TestName "Offline Navigation" -TestScript { Test-OfflineNavigation }

# Test Ã¶zeti
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           ğŸ“Š Test SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$successRate = if ($testResults.TotalTests -gt 0) {
    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)
} else { 0 }

Write-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"
Write-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"
Write-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"
Write-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"
Write-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"

# DetaylÄ± sonuÃ§lar
if ($Verbose) {
    Write-ColorOutput "" "White"
    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"
    foreach ($detail in $testResults.Details) {
        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }
        Write-ColorOutput "  $status $($detail.TestName)" "White"
        if (!$detail.Passed -and $detail.ErrorMessage) {
            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"
        }
    }
}

# JSON export
if ($ExportJson) {
    $jsonPath = Join-Path $ProjectPath "navigation-simulation-test-results.json"
    $exportData = @{
        metadata = @{
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            script_version = "1.0.0"
            test_environment = $TestEnvironment
            simulation_speed = $SimulationSpeed
            simulation_mode = $SimulationMode
            total_duration_seconds = $testResults.TestDuration.TotalSeconds
        }
        summary = @{
            total_tests = $testResults.TotalTests
            passed_tests = $testResults.PassedTests
            failed_tests = $testResults.FailedTests
            success_rate = $successRate
            test_duration = $testResults.TestDuration.ToString()
        }
        configuration = @{
            simulation_speed = $SimulationSpeed
            simulation_mode = $SimulationMode
            enable_logging = $Verbose
            test_environment = $TestEnvironment
        }
        details = $testResults.Details
        recommendations = @(
            "GPS mock sistemini test ortamÄ±nda etkinleÅŸtirin",
            "Rota sapmasÄ± senaryolarÄ±nÄ± daha sÄ±k test edin",
            "Offline tile verilerini gÃ¼ncel tutun",
            "SimÃ¼lasyon hÄ±zÄ±nÄ± CI/CD ortamÄ±na gÃ¶re ayarlayÄ±n"
        )
    }

    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
    Write-ColorOutput "ğŸ“„ Test sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"
}

# Badge tetikleme
if ($testResults.PassedTests -gt 0) {
    Show-Badge "Navigation-Simulated"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($testResults.FailedTests -eq 0) {
    Write-ColorOutput "ğŸ‰ TÃ¼m navigation simÃ¼lasyon testleri baÅŸarÄ±lÄ±! CI/CD pipeline devam edebilir." "Green"
    exit 0
} else {
    Write-ColorOutput "ğŸ’¥ BazÄ± navigation simÃ¼lasyon testleri baÅŸarÄ±sÄ±z. LÃ¼tfen simÃ¼lasyon ayarlarÄ±nÄ± kontrol edin." "Red"
    exit 1
}

# Badge gÃ¶sterme fonksiyonu
function Show-Badge {
    param([string]$BadgeName)

    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"

    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)
    $badgeFile = Join-Path $ProjectPath "badge.json"
    if (Test-Path $badgeFile) {
        try {
            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json
            if ($badgeData.PSObject.Properties.Name -notcontains $BadgeName) {
                $badgeData | Add-Member -MemberType NoteProperty -Name $BadgeName -Value $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            } else {
                $badgeData.$BadgeName = $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            }
        } catch {
            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"
        }
    } else {
        # Yeni badge dosyasÄ± oluÅŸtur
        $newBadgeData = @{
            $BadgeName = $true
        }
        $newBadgeData | ConvertTo-Json | Set-Content $badgeFile
        Write-ColorOutput "  âœ… Yeni badge dosyasÄ± oluÅŸturuldu" "Green"
    }
}
