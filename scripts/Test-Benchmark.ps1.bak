# Test-Benchmark.ps1 - Dinamik benchmark testi
# Bu script benchmark sistemini test eder ve CI/CD pipeline ile entegre Ã§alÄ±ÅŸÄ±r

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose,
    [switch]$ExportJson,
    [int]$MaxBenchmarkHistory = 1000,
    [double]$PerformanceThreshold = 0.1,
    [string[]]$MonitoredMetrics = @("route_calculation", "map_rendering", "tile_loading", "api_response")
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler
$testResults = @{
    TotalTests = 0
    PassedTests = 0
    FailedTests = 0
    TestDuration = [TimeSpan]::Zero
    Details = @()
}

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:AUTO_SAVE_BENCHMARKS = "true"
$env:MAX_BENCHMARK_HISTORY = $MaxBenchmarkHistory.ToString()
$env:PERFORMANCE_THRESHOLD = $PerformanceThreshold.ToString()
$env:MONITORED_METRICS = $MonitoredMetrics -join ","

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "      ğŸ“Š Dinamik Benchmark Testi" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# Test fonksiyonlarÄ±
function Test-BenchmarkSystem {
    param(
        [string]$TestName,
        [scriptblock]$TestScript
    )

    $startTime = Get-Date
    $testPassed = $false
    $errorMessage = ""

    Write-ColorOutput "ğŸ§ª $TestName testi baÅŸlatÄ±lÄ±yor..." "White"

    try {
        & $TestScript
        $testPassed = $true
        Write-ColorOutput "  âœ… $TestName testi baÅŸarÄ±lÄ±" "Green"
    } catch {
        $errorMessage = $_.Exception.Message
        Write-ColorOutput "  âŒ $TestName testi baÅŸarÄ±sÄ±z: $errorMessage" "Red"
    } finally {
        $endTime = Get-Date
        $duration = $endTime - $startTime

        $testResults.TotalTests++
        if ($testPassed) {
            $testResults.PassedTests++
        } else {
            $testResults.FailedTests++
        }
        $testResults.TestDuration += $duration

        $testResults.Details += @{
            TestName = $TestName
            Passed = $testPassed
            Duration = $duration
            ErrorMessage = $errorMessage
        }
    }
}

# Benchmark veri yapÄ±sÄ± testi
function Test-BenchmarkDataStructure {
    Write-ColorOutput "  ğŸ“Š Benchmark veri yapÄ±sÄ± test ediliyor..." "Gray"

    # Benchmark veri klasÃ¶rÃ¼ kontrolÃ¼
    $benchmarkDataPath = Join-Path $env:APPDATA "KesifUygulamasi\BenchmarkData"
    if (!(Test-Path $benchmarkDataPath)) {
        New-Item -ItemType Directory -Path $benchmarkDataPath -Force | Out-Null
        Write-ColorOutput "    ğŸ“ Benchmark veri klasÃ¶rÃ¼ oluÅŸturuldu" "Gray"
    }

    # Ã–rnek benchmark dosyasÄ± oluÅŸtur
    $sampleBenchmark = @{
        metric = "route_calculation"
        value = 150.5
        unit = "ms"
        timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
        category = "Navigation"
        metadata = @{
            environment = "Test"
            platform = "Windows"
            framework = "NET8.0"
        }
        isBaseline = $false
    }

    $benchmarkFile = Join-Path $benchmarkDataPath "benchmark_test_$(Get-Date -Format 'yyyyMMdd_HHmmss').json"
    $sampleBenchmark | ConvertTo-Json -Depth 10 | Set-Content $benchmarkFile

    Write-ColorOutput "    ğŸ“„ Ã–rnek benchmark dosyasÄ± oluÅŸturuldu: $benchmarkFile" "Gray"

    # JSON validasyonu
    try {
        $content = Get-Content $benchmarkFile -Raw | ConvertFrom-Json
        Write-ColorOutput "    âœ… JSON formatÄ± geÃ§erli" "Green"
    } catch {
        Write-ColorOutput "    âŒ JSON format hatasÄ±" "Red"
        throw
    }
}

# Performans Ã¶lÃ§Ã¼mÃ¼ testi
function Test-PerformanceMeasurement {
    Write-ColorOutput "  â±ï¸  Performans Ã¶lÃ§Ã¼mÃ¼ test ediliyor..." "Gray"

    # Ã–rnek performans metrikleri
    $testMetrics = @(
        @{ Name = "route_calculation"; Value = 145.2; Unit = "ms"; Category = "Navigation" },
        @{ Name = "map_rendering"; Value = 42.8; Unit = "ms"; Category = "UI" },
        @{ Name = "tile_loading"; Value = 118.5; Unit = "ms"; Category = "Data" },
        @{ Name = "api_response"; Value = 195.3; Unit = "ms"; Category = "Network" },
        @{ Name = "database_query"; Value = 23.7; Unit = "ms"; Category = "Data" }
    )

    foreach ($metric in $testMetrics) {
        Write-ColorOutput "    ğŸ“ $($metric.Name): $($metric.Value) $($metric.Unit) ($($metric.Category))" "Gray"
    }

    Write-ColorOutput "    ğŸ“Š Test edilen metrik sayÄ±sÄ±: $($testMetrics.Count)" "Gray"
}

# Baseline karÅŸÄ±laÅŸtÄ±rma testi
function Test-BaselineComparison {
    Write-ColorOutput "  ğŸ“ˆ Baseline karÅŸÄ±laÅŸtÄ±rma test ediliyor..." "Gray"

    # Baseline dosyasÄ± oluÅŸtur
    $benchmarkDataPath = Join-Path $env:APPDATA "KesifUygulamasi\BenchmarkData"
    $baselineFile = Join-Path $benchmarkDataPath "baselines.json"

    $baselines = @{
        "route_calculation" = 140.0
        "map_rendering" = 40.0
        "tile_loading" = 110.0
        "api_response" = 180.0
    }

    $baselines | ConvertTo-Json | Set-Content $baselineFile
    Write-ColorOutput "    ğŸ“„ Baseline dosyasÄ± oluÅŸturuldu" "Gray"

    # KarÅŸÄ±laÅŸtÄ±rma testi
    $testValues = @{
        "route_calculation" = 150.5
        "map_rendering" = 38.2
        "tile_loading" = 125.8
        "api_response" = 175.3
    }

    foreach ($metric in $testValues.Keys) {
        $baseline = $baselines[$metric]
        $current = $testValues[$metric]
        $deviation = (($current - $baseline) / $baseline) * 100

        $status = if ([Math]::Abs($deviation) -le ($PerformanceThreshold * 100)) { "âœ…" } else { "âš ï¸" }
        Write-ColorOutput "    $status $metric : ${current}ms (Baseline: ${baseline}ms, Deviation: ${deviation:F2}%)" "Gray"
    }
}

# Metrik izleme testi
function Test-MetricMonitoring {
    Write-ColorOutput "  ğŸ“‹ Metrik izleme test ediliyor..." "Gray"

    $monitoredMetrics = $env:MONITORED_METRICS -split ","
    Write-ColorOutput "    ğŸ“ Ä°zlenen metrikler: $($monitoredMetrics -join ', ')" "Gray"

    # Her metrik iÃ§in Ã¶rnek deÄŸerler
    $metricSamples = @{
        "route_calculation" = @(145.2, 152.8, 138.5, 149.3, 141.7)
        "map_rendering" = @(42.8, 38.2, 45.6, 41.3, 39.8)
        "tile_loading" = @(118.5, 125.8, 112.3, 121.7, 115.4)
        "api_response" = @(195.3, 182.7, 201.2, 188.5, 197.8)
    }

    foreach ($metric in $monitoredMetrics) {
        if ($metricSamples.ContainsKey($metric)) {
            $values = $metricSamples[$metric]
            $avg = ($values | Measure-Object -Average).Average
            $min = ($values | Measure-Object -Minimum).Minimum
            $max = ($values | Measure-Object -Maximum).Maximum

            Write-ColorOutput "    ğŸ“Š $metric - Avg: ${avg:F1}ms, Min: ${min:F1}ms, Max: ${max:F1}ms" "Gray"
        }
    }
}

# Performans regresyon testi
function Test-PerformanceRegression {
    Write-ColorOutput "  ğŸ“‰ Performans regresyon testi..." "Gray"

    # SimÃ¼le edilmiÅŸ geÃ§miÅŸ veriler
    $historicalData = @(
        @{ Date = "2024-01-01"; Value = 140.0 },
        @{ Date = "2024-01-02"; Value = 142.5 },
        @{ Date = "2024-01-03"; Value = 138.8 },
        @{ Date = "2024-01-04"; Value = 145.2 },
        @{ Date = "2024-01-05"; Value = 141.7 }
    )

    $currentValue = 155.3
    $averageHistorical = ($historicalData | ForEach-Object { $_.Value } | Measure-Object -Average).Average
    $regression = (($currentValue - $averageHistorical) / $averageHistorical) * 100

    Write-ColorOutput "    ğŸ“ˆ GeÃ§miÅŸ ortalama: ${averageHistorical:F1}ms" "Gray"
    Write-ColorOutput "    ğŸ“ˆ GÃ¼ncel deÄŸer: ${currentValue:F1}ms" "Gray"
    Write-ColorOutput "    ğŸ“ˆ Regresyon: ${regression:F2}%" "Gray"

    if ([Math]::Abs($regression) -gt ($PerformanceThreshold * 100)) {
        Write-ColorOutput "    âš ï¸  Performans regresyonu tespit edildi!" "Yellow"
    } else {
        Write-ColorOutput "    âœ… Performans regresyonu yok" "Green"
    }
}

# GeÃ§miÅŸ veri yÃ¶netimi testi
function Test-HistoricalDataManagement {
    Write-ColorOutput "  ğŸ“š GeÃ§miÅŸ veri yÃ¶netimi test ediliyor..." "Gray"

    $maxHistory = [int]$env:MAX_BENCHMARK_HISTORY
    Write-ColorOutput "    ğŸ“ Maksimum geÃ§miÅŸ kaydÄ±: $maxHistory" "Gray"

    # GeÃ§miÅŸ dosya sayÄ±sÄ± kontrolÃ¼
    $benchmarkDataPath = Join-Path $env:APPDATA "KesifUygulamasi\BenchmarkData"
    $benchmarkFiles = Get-ChildItem $benchmarkDataPath -Filter "benchmark_*.json"

    Write-ColorOutput "    ğŸ“„ Mevcut benchmark dosyasÄ± sayÄ±sÄ±: $($benchmarkFiles.Count)" "Gray"

    if ($benchmarkFiles.Count -gt $maxHistory) {
        Write-ColorOutput "    âš ï¸  GeÃ§miÅŸ dosya sayÄ±sÄ± limiti aÅŸÄ±lmÄ±ÅŸ" "Yellow"
    } else {
        Write-ColorOutput "    âœ… GeÃ§miÅŸ dosya sayÄ±sÄ± limit iÃ§inde" "Green"
    }

    # En eski dosyalarÄ± listele
    $oldestFiles = $benchmarkFiles | Sort-Object LastWriteTime | Select-Object -First 5
    if ($oldestFiles) {
        Write-ColorOutput "    ğŸ“… En eski 5 dosya:" "Gray"
        foreach ($file in $oldestFiles) {
            Write-ColorOutput "      - $($file.Name) ($($file.LastWriteTime))" "Gray"
        }
    }
}

# Ana test dÃ¶ngÃ¼sÃ¼
Write-ColorOutput "ğŸš€ Dinamik benchmark testleri baÅŸlatÄ±lÄ±yor..." "White"
Write-ColorOutput ""

# Testleri Ã§alÄ±ÅŸtÄ±r
Test-BenchmarkSystem -TestName "Benchmark Veri YapÄ±sÄ±" -TestScript { Test-BenchmarkDataStructure }
Test-BenchmarkSystem -TestName "Performans Ã–lÃ§Ã¼mÃ¼" -TestScript { Test-PerformanceMeasurement }
Test-BenchmarkSystem -TestName "Baseline KarÅŸÄ±laÅŸtÄ±rma" -TestScript { Test-BaselineComparison }
Test-BenchmarkSystem -TestName "Metrik Ä°zleme" -TestScript { Test-MetricMonitoring }
Test-BenchmarkSystem -TestName "Performans Regresyon" -TestScript { Test-PerformanceRegression }
Test-BenchmarkSystem -TestName "GeÃ§miÅŸ Veri YÃ¶netimi" -TestScript { Test-HistoricalDataManagement }

# Test Ã¶zeti
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           ğŸ“Š Test SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$successRate = if ($testResults.TotalTests -gt 0) {
    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)
} else { 0 }

Write-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"
Write-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"
Write-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"
Write-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"
Write-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"

# DetaylÄ± sonuÃ§lar
if ($Verbose) {
    Write-ColorOutput "" "White"
    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"
    foreach ($detail in $testResults.Details) {
        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }
        Write-ColorOutput "  $status $($detail.TestName)" "White"
        if (!$detail.Passed -and $detail.ErrorMessage) {
            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"
        }
    }
}

# JSON export
if ($ExportJson) {
    $jsonPath = Join-Path $ProjectPath "benchmark-test-results.json"
    $exportData = @{
        metadata = @{
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            script_version = "1.0.0"
            test_environment = $TestEnvironment
            max_benchmark_history = $MaxBenchmarkHistory
            performance_threshold = $PerformanceThreshold
            monitored_metrics = $MonitoredMetrics
            total_duration_seconds = $testResults.TestDuration.TotalSeconds
        }
        summary = @{
            total_tests = $testResults.TotalTests
            passed_tests = $testResults.PassedTests
            failed_tests = $testResults.FailedTests
            success_rate = $successRate
            test_duration = $testResults.TestDuration.ToString()
        }
        performance_metrics = @{
            monitored_count = $MonitoredMetrics.Count
            baseline_configured = $true
            regression_detection = $true
        }
        details = $testResults.Details
        recommendations = @(
            "Baseline deÄŸerlerini production ortamÄ±nda dÃ¼zenli gÃ¼ncelleyin",
            "Performans threshold'unu uygulama ihtiyaÃ§larÄ±na gÃ¶re ayarlayÄ±n",
            "Benchmark geÃ§miÅŸini periyodik olarak arÅŸivleyin",
            "Regresyon alertlerini monitoring sistemine entegre edin"
        )
    }

    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
    Write-ColorOutput "ğŸ“„ Test sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"
}

# Badge tetikleme
if ($testResults.PassedTests -gt 0) {
    Show-Badge "Benchmark-Logged"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($testResults.FailedTests -eq 0) {
    Write-ColorOutput "ğŸ‰ TÃ¼m dinamik benchmark testleri baÅŸarÄ±lÄ±! CI/CD pipeline devam edebilir." "Green"
    exit 0
} else {
    Write-ColorOutput "ğŸ’¥ BazÄ± benchmark testleri baÅŸarÄ±sÄ±z. LÃ¼tfen performans metriklerini kontrol edin." "Red"
    exit 1
}

# Badge gÃ¶sterme fonksiyonu
function Show-Badge {
    param([string]$BadgeName)

    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"

    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)
    $badgeFile = Join-Path $ProjectPath "badge.json"
    if (Test-Path $badgeFile) {
        try {
            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json
            if ($badgeData.PSObject.Properties.Name -notcontains $BadgeName) {
                $badgeData | Add-Member -MemberType NoteProperty -Name $BadgeName -Value $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            } else {
                $badgeData.$BadgeName = $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            }
        } catch {
            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"
        }
    } else {
        # Yeni badge dosyasÄ± oluÅŸtur
        $newBadgeData = @{
            $BadgeName = $true
        }
        $newBadgeData | ConvertTo-Json | Set-Content $badgeFile
        Write-ColorOutput "  âœ… Yeni badge dosyasÄ± oluÅŸturuldu" "Green"
    }
}
