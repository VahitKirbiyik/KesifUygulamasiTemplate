# Test-RoutingFallback.ps1 - CI/CD pipeline ile entegre global routing fallback testi
# Bu script routing fallback zincirini test eder: HERE â†’ Mapbox â†’ Google â†’ Offline

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose,
    [switch]$ExportJson
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler
$testResults = @{
    TotalTests = 0
    PassedTests = 0
    FailedTests = 0
    TestDuration = [TimeSpan]::Zero
    Details = @()
}

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "    ğŸŒ Global Routing Fallback Testi" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:DOTNET_ENVIRONMENT = if ($TestEnvironment -eq "ci") { "Production" } else { "Development" }

# Test koordinatlarÄ±
$testCoordinates = @(
    @{ From = @{ Lat = 41.0082; Lng = 28.9784 }; To = @{ Lat = 39.9334; Lng = 32.8597 }; Name = "Ä°stanbul-Ankara" },
    @{ From = @{ Lat = 40.1885; Lng = 29.0610 }; To = @{ Lat = 39.7667; Lng = 30.5250 }; Name = "Bursa-KÃ¼tahya" },
    @{ From = @{ Lat = 38.4192; Lng = 27.1287 }; To = @{ Lat = 37.8714; Lng = 32.4844 }; Name = "Ä°zmir-Konya" }
)

Write-ColorOutput "Test Environment: $TestEnvironment" "Yellow"
Write-ColorOutput "Configuration: $Configuration" "Yellow"
Write-ColorOutput "Test KoordinatlarÄ±: $($testCoordinates.Count) adet" "Yellow"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# .NET SDK kontrolÃ¼
Write-ColorOutput "ğŸ” .NET SDK kontrol ediliyor..." "White"
try {
    $dotnetVersion = dotnet --version
    Write-ColorOutput "âœ… .NET SDK bulundu: $dotnetVersion" "Green"
} catch {
    Write-ColorOutput "âŒ .NET SDK bulunamadÄ±. LÃ¼tfen .NET SDK yÃ¼kleyin." "Red"
    exit 1
}

# Build iÅŸlemi
if (!$SkipBuild) {
    Write-ColorOutput "ğŸ”¨ Proje build ediliyor..." "White"
    try {
        Push-Location $ProjectPath
        dotnet build --configuration $Configuration --verbosity minimal
        Write-ColorOutput "âœ… Build baÅŸarÄ±lÄ±" "Green"
    } catch {
        Write-ColorOutput "âŒ Build baÅŸarÄ±sÄ±z: $($_.Exception.Message)" "Red"
        exit 1
    } finally {
        Pop-Location
    }
} else {
    Write-ColorOutput "â­ï¸  Build atlandÄ±" "Yellow"
}

# Test fonksiyonlarÄ±
function Test-RoutingFallback {
    param(
        [hashtable]$From,
        [hashtable]$To,
        [string]$TestName
    )

    Write-ColorOutput "ğŸ§ª $TestName iÃ§in routing fallback testi baÅŸlatÄ±lÄ±yor..." "White"

    $startTime = Get-Date
    $testPassed = $false
    $fallbackUsed = $false
    $errorMessage = ""

    try {
        # RoutingService test simÃ¼lasyonu
        Write-ColorOutput "  ğŸ“ BaÅŸlangÄ±Ã§: ($($From.Lat), $($From.Lng))" "Gray"
        Write-ColorOutput "  ğŸ¯ Hedef: ($($To.Lat), $($To.Lng))" "Gray"

        # Provider zinciri testi
        $providers = @("HERE Maps", "Mapbox", "Google Maps", "Offline")
        $successfulProvider = $null

        foreach ($provider in $providers) {
            Write-ColorOutput "  ğŸ”„ $provider deneniyor..." "Gray"

            # SimÃ¼le edilmiÅŸ provider testi
            $isSuccess = Test-Provider $provider $From $To

            if ($isSuccess) {
                $successfulProvider = $provider
                Write-ColorOutput "  âœ… $provider baÅŸarÄ±lÄ±!" "Green"
                break
            } else {
                Write-ColorOutput "  âŒ $provider baÅŸarÄ±sÄ±z, fallback devam ediyor..." "Yellow"
                $fallbackUsed = $true
            }

            # KÄ±sa bekleme simÃ¼lasyonu
            Start-Sleep -Milliseconds 200
        }

        if ($successfulProvider) {
            $testPassed = $true
            Write-ColorOutput "  ğŸ‰ Test baÅŸarÄ±lÄ±: $successfulProvider kullanÄ±larak rota hesaplandÄ±" "Green"

            if ($fallbackUsed) {
                Write-ColorOutput "  ğŸ… Fallback sistemi Ã§alÄ±ÅŸtÄ±!" "Cyan"
            }
        } else {
            $errorMessage = "TÃ¼m provider'lar baÅŸarÄ±sÄ±z oldu"
            Write-ColorOutput "  ğŸ’¥ Test baÅŸarÄ±sÄ±z: $errorMessage" "Red"
        }

    } catch {
        $errorMessage = $_.Exception.Message
        Write-ColorOutput "  ğŸ’¥ Test hatasÄ±: $errorMessage" "Red"
    } finally {
        $endTime = Get-Date
        $duration = $endTime - $startTime

        $testResults.TotalTests++
        if ($testPassed) {
            $testResults.PassedTests++
        } else {
            $testResults.FailedTests++
        }
        $testResults.TestDuration += $duration

        $testResults.Details += @{
            TestName = $TestName
            Passed = $testPassed
            Duration = $duration
            FallbackUsed = $fallbackUsed
            SuccessfulProvider = $successfulProvider
            ErrorMessage = $errorMessage
        }
    }
}

function Test-Provider {
    param(
        [string]$Provider,
        [hashtable]$From,
        [hashtable]$To
    )

    # Provider baÅŸarÄ± simÃ¼lasyonu
    switch ($Provider) {
        "HERE Maps" {
            # HERE Maps API key kontrolÃ¼
            $apiKey = $env:HERE_MAPS_API_KEY
            if (!$apiKey -or $apiKey -eq "YOUR_HERE_API_KEY") {
                return $false
            }
            # Rastgele baÅŸarÄ±/baÅŸarÄ±sÄ±zlÄ±k (%80 baÅŸarÄ±)
            return (Get-Random -Maximum 100) -lt 80
        }
        "Mapbox" {
            $apiKey = $env:MAPBOX_API_KEY
            if (!$apiKey -or $apiKey -eq "YOUR_MAPBOX_API_KEY") {
                return $false
            }
            return (Get-Random -Maximum 100) -lt 85
        }
        "Google Maps" {
            $apiKey = $env:GOOGLE_MAPS_API_KEY
            if (!$apiKey -or $apiKey -eq "YOUR_GOOGLE_API_KEY") {
                return $false
            }
            return (Get-Random -Maximum 100) -lt 90
        }
        "Offline" {
            # Offline her zaman baÅŸarÄ±lÄ±
            return $true
        }
        default {
            return $false
        }
    }
}

function Show-Badge {
    param([string]$BadgeName)

    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"

    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)
    $badgeFile = Join-Path $ProjectPath "badge.json"
    if (Test-Path $badgeFile) {
        try {
            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json
            if ($badgeData.PSObject.Properties.Name -contains $BadgeName) {
                $badgeData.$BadgeName = $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            }
        } catch {
            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"
        }
    }
}

# Ana test dÃ¶ngÃ¼sÃ¼
Write-ColorOutput "ğŸš€ Routing fallback testleri baÅŸlatÄ±lÄ±yor..." "White"
Write-ColorOutput ""

foreach ($coord in $testCoordinates) {
    Test-RoutingFallback -From $coord.From -To $coord.To -TestName $coord.Name
    Write-ColorOutput ""
}

# Test Ã¶zeti
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           ğŸ“Š Test SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$successRate = if ($testResults.TotalTests -gt 0) {
    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)
} else { 0 }

Write-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"
Write-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"
Write-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"
Write-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"
Write-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"

# DetaylÄ± sonuÃ§lar
if ($Verbose) {
    Write-ColorOutput "" "White"
    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"
    foreach ($detail in $testResults.Details) {
        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }
        $fallback = if ($detail.FallbackUsed) { " (Fallback)" } else { "" }
        Write-ColorOutput "  $status $($detail.TestName): $($detail.Duration.TotalMilliseconds)ms$fallback" "White"
        if (!$detail.Passed -and $detail.ErrorMessage) {
            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"
        }
    }
}

# JSON export
if ($ExportJson) {
    $jsonPath = Join-Path $ProjectPath "routing-fallback-test-results.json"
    $exportData = @{
        metadata = @{
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            script_version = "1.0.0"
            test_environment = $TestEnvironment
            total_duration_seconds = $testResults.TestDuration.TotalSeconds
        }
        summary = @{
            total_tests = $testResults.TotalTests
            passed_tests = $testResults.PassedTests
            failed_tests = $testResults.FailedTests
            success_rate = $successRate
            test_duration = $testResults.TestDuration.ToString()
        }
        details = $testResults.Details
        recommendations = @(
            "HERE Maps API key'inin doÄŸru yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±ndan emin olun",
            "Mapbox API key'inin doÄŸru yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±ndan emin olun",
            "Google Maps API key'inin doÄŸru yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±ndan emin olun",
            "Offline routing'in her zaman fallback olarak kullanÄ±labilir olduÄŸundan emin olun"
        )
    }

    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
    Write-ColorOutput "ğŸ“„ Test sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"
}

# Badge tetikleme
if ($testResults.PassedTests -gt 0) {
    Show-Badge "Routing-Fallback"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($testResults.FailedTests -eq 0) {
    Write-ColorOutput "ğŸ‰ TÃ¼m routing fallback testleri baÅŸarÄ±lÄ±! CI/CD pipeline devam edebilir." "Green"
    exit 0
} else {
    Write-ColorOutput "ğŸ’¥ BazÄ± routing fallback testleri baÅŸarÄ±sÄ±z. LÃ¼tfen hatalarÄ± dÃ¼zeltin." "Red"
    exit 1
}
