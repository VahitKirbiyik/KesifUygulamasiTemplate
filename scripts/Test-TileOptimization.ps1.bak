# Test-TileOptimization.ps1 - Tile optimizasyon test scripti
# CI/CD pipeline ile entegre edilmiÅŸ offline tile compression ve prefetch testi

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose,
    [switch]$ExportJson,
    [string]$CachePath = "cache\tiles",
    [string]$CompressedPath = "cache\compressed",
    [int]$TestTileCount = 100,
    [int]$CompressionLevel = 6
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler
$testResults = @{
    TotalTests = 0
    PassedTests = 0
    FailedTests = 0
    TestDuration = [TimeSpan]::Zero
    Details = @()
    CompressionStats = @{
        OriginalSize = 0
        CompressedSize = 0
        CompressionRatio = 0
        TilesCompressed = 0
    }
    PrefetchStats = @{
        TilesPrefetched = 0
        PrefetchDuration = [TimeSpan]::Zero
        CacheHitRate = 0
    }
}

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:TILE_CACHE_PATH = $CachePath
$env:COMPRESSED_TILE_PATH = $CompressedPath
$env:COMPRESSION_LEVEL = $CompressionLevel.ToString()
$env:ENABLE_TILE_COMPRESSION = "true"
$env:MAX_TILE_SIZE_MB = "10"
$env:ENABLE_PREFETCH = "true"
$env:MAX_CONCURRENT_DOWNLOADS = "3"
$env:PREFETCH_RADIUS = "2"

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "      ğŸ—ºï¸ Tile Optimizasyon Test Sistemi" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# Test fonksiyonlarÄ±
function Test-TileOptimization {
    param(
        [string]$TestName,
        [scriptblock]$TestScript
    )

    $startTime = Get-Date
    $testPassed = $false
    $errorMessage = ""

    Write-ColorOutput "ğŸ§ª $TestName testi baÅŸlatÄ±lÄ±yor..." "White"

    try {
        & $TestScript
        $testPassed = $true
        Write-ColorOutput "  âœ… $TestName testi baÅŸarÄ±lÄ±" "Green"
    } catch {
        $errorMessage = $_.Exception.Message
        Write-ColorOutput "  âŒ $TestName testi baÅŸarÄ±sÄ±z: $errorMessage" "Red"
    } finally {
        $endTime = Get-Date
        $duration = $endTime - $startTime

        $testResults.TotalTests++
        if ($testPassed) {
            $testResults.PassedTests++
        } else {
            $testResults.FailedTests++
        }
        $testResults.TestDuration += $duration

        $testResults.Details += @{
            TestName = $TestName
            Passed = $testPassed
            Duration = $duration
            ErrorMessage = $errorMessage
        }
    }
}

# Cache klasÃ¶rÃ¼ oluÅŸturma testi
function Test-CacheDirectorySetup {
    Write-ColorOutput "  ğŸ“ Cache klasÃ¶rÃ¼ kurulumu kontrol ediliyor..." "Gray"

    $fullCachePath = Join-Path $ProjectPath $CachePath
    $fullCompressedPath = Join-Path $ProjectPath $CompressedPath

    if (!(Test-Path $fullCachePath)) {
        Write-ColorOutput "    ğŸ“‚ Cache klasÃ¶rÃ¼ oluÅŸturuluyor: $fullCachePath" "Gray"
        New-Item -ItemType Directory -Path $fullCachePath -Force | Out-Null
    } else {
        Write-ColorOutput "    âœ… Cache klasÃ¶rÃ¼ mevcut: $fullCachePath" "Green"
    }

    if (!(Test-Path $fullCompressedPath)) {
        Write-ColorOutput "    ğŸ“‚ SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ cache klasÃ¶rÃ¼ oluÅŸturuluyor: $fullCompressedPath" "Gray"
        New-Item -ItemType Directory -Path $fullCompressedPath -Force | Out-Null
    } else {
        Write-ColorOutput "    âœ… SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ cache klasÃ¶rÃ¼ mevcut: $fullCompressedPath" "Green"
    }

    # Test tile dosyasÄ± oluÅŸtur
    $testTilePath = Join-Path $fullCachePath "test-tile.png"
    $testData = [byte[]]::new(1024) # 1KB test verisi
    [System.Random]::new().NextBytes($testData)
    [System.IO.File]::WriteAllBytes($testTilePath, $testData)

    if (Test-Path $testTilePath) {
        Write-ColorOutput "    âœ… Test tile dosyasÄ± oluÅŸturuldu" "Green"
        Remove-Item $testTilePath -Force
    } else {
        Write-ColorOutput "    âŒ Test tile dosyasÄ± oluÅŸturulamadÄ±" "Red"
        throw "Cache directory setup failed"
    }
}

# Tile sÄ±kÄ±ÅŸtÄ±rma testi
function Test-TileCompression {
    Write-ColorOutput "  ğŸ—œï¸ Tile sÄ±kÄ±ÅŸtÄ±rma testi baÅŸlatÄ±lÄ±yor..." "Gray"

    $fullCachePath = Join-Path $ProjectPath $CachePath
    $fullCompressedPath = Join-Path $ProjectPath $CompressedPath

    # Test tile'larÄ± oluÅŸtur
    $testTiles = @()
    for ($i = 1; $i -le 10; $i++) {
        $tileData = [byte[]]::new(2048 + ($i * 100)) # FarklÄ± boyutlarda tile'lar
        [System.Random]::new().NextBytes($tileData)

        $tileKey = "15/1234/5678_$i"
        $testTiles += @{
            Key = $tileKey
            Data = $tileData
            OriginalSize = $tileData.Length
        }
    }

    $totalOriginalSize = 0
    $totalCompressedSize = 0
    $compressedTiles = 0

    foreach ($tile in $testTiles) {
        try {
            # GZip sÄ±kÄ±ÅŸtÄ±rma simÃ¼lasyonu
            $compressedData = Compress-TileData $tile.Data
            $totalOriginalSize += $tile.OriginalSize
            $totalCompressedSize += $compressedData.Length
            $compressedTiles++

            # SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ dosyayÄ± kaydet
            $compressedFilePath = Get-CompressedTilePath $tile.Key $fullCompressedPath
            $directory = [System.IO.Path]::GetDirectoryName($compressedFilePath)
            if (!(Test-Path $directory)) {
                New-Item -ItemType Directory -Path $directory -Force | Out-Null
            }
            [System.IO.File]::WriteAllBytes($compressedFilePath, $compressedData)

            Write-ColorOutput "    ğŸ“¦ Tile sÄ±kÄ±ÅŸtÄ±rÄ±ldÄ±: $($tile.Key) ($($tile.OriginalSize) -> $($compressedData.Length) bytes)" "Gray"
        } catch {
            Write-ColorOutput "    âŒ Tile sÄ±kÄ±ÅŸtÄ±rma hatasÄ±: $($tile.Key) - $($_.Exception.Message)" "Red"
        }
    }

    # SÄ±kÄ±ÅŸtÄ±rma istatistiklerini hesapla
    $compressionRatio = if ($totalOriginalSize -gt 0) { $totalCompressedSize / $totalOriginalSize } else { 0 }
    $spaceSaved = $totalOriginalSize - $totalCompressedSize

    Write-ColorOutput "    ğŸ“Š SÄ±kÄ±ÅŸtÄ±rma Ä°statistikleri:" "Gray"
    Write-ColorOutput "      - SÄ±kÄ±ÅŸtÄ±rÄ±lan Tile: $compressedTiles" "Gray"
    Write-ColorOutput "      - Orijinal Boyut: $([math]::Round($totalOriginalSize/1024, 2)) KB" "Gray"
    Write-ColorOutput "      - SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ Boyut: $([math]::Round($totalCompressedSize/1024, 2)) KB" "Gray"
    Write-ColorOutput "      - SÄ±kÄ±ÅŸtÄ±rma OranÄ±: $([math]::Round($compressionRatio, 3))" "Gray"
    Write-ColorOutput "      - Tasarruf: $([math]::Round($spaceSaved/1024, 2)) KB" "Green"

    # Test sonuÃ§larÄ±nÄ± gÃ¼ncelle
    $testResults.CompressionStats.OriginalSize = $totalOriginalSize
    $testResults.CompressionStats.CompressedSize = $totalCompressedSize
    $testResults.CompressionStats.CompressionRatio = $compressionRatio
    $testResults.CompressionStats.TilesCompressed = $compressedTiles

    if ($compressionRatio -lt 1) {
        Write-ColorOutput "    âœ… Tile sÄ±kÄ±ÅŸtÄ±rma baÅŸarÄ±lÄ±" "Green"
    } else {
        Write-ColorOutput "    âš ï¸  SÄ±kÄ±ÅŸtÄ±rma etkisi sÄ±nÄ±rlÄ±" "Yellow"
    }
}

# Tile aÃ§ma testi
function Test-TileDecompression {
    Write-ColorOutput "  ğŸ“¤ Tile aÃ§ma testi baÅŸlatÄ±lÄ±yor..." "Gray"

    $fullCompressedPath = Join-Path $ProjectPath $CompressedPath
    $decompressedTiles = 0
    $totalDecompressedSize = 0

    # SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ tile dosyalarÄ±nÄ± bul
    $compressedFiles = Get-ChildItem $fullCompressedPath -Filter "*.tile" -Recurse

    foreach ($file in $compressedFiles) {
        try {
            $compressedData = [System.IO.File]::ReadAllBytes($file.FullName)
            $decompressedData = Decompress-TileData $compressedData

            $totalDecompressedSize += $decompressedData.Length
            $decompressedTiles++

            Write-ColorOutput "    ğŸ“¦ Tile aÃ§Ä±ldÄ±: $($file.Name) ($($compressedData.Length) -> $($decompressedData.Length) bytes)" "Gray"
        } catch {
            Write-ColorOutput "    âŒ Tile aÃ§ma hatasÄ±: $($file.Name) - $($_.Exception.Message)" "Red"
        }
    }

    Write-ColorOutput "    ğŸ“Š AÃ§ma Ä°statistikleri:" "Gray"
    Write-ColorOutput "      - AÃ§Ä±lan Tile: $decompressedTiles" "Gray"
    Write-ColorOutput "      - Toplam Boyut: $([math]::Round($totalDecompressedSize/1024, 2)) KB" "Gray"

    if ($decompressedTiles -gt 0) {
        Write-ColorOutput "    âœ… Tile aÃ§ma baÅŸarÄ±lÄ±" "Green"
    } else {
        Write-ColorOutput "    âŒ HiÃ§ tile aÃ§Ä±lmadÄ±" "Red"
        throw "Tile decompression failed"
    }
}

# Prefetch testi
function Test-TilePrefetch {
    Write-ColorOutput "  ğŸš€ Tile prefetch testi baÅŸlatÄ±lÄ±yor..." "Gray"

    $prefetchStartTime = Get-Date

    # Mock rota noktalarÄ± oluÅŸtur
    $routePoints = @()
    for ($i = 0; $i -lt 20; $i++) {
        $routePoints += @{
            Lat = 41.0082 + ($i * 0.001)  # Ä°stanbul koordinatlarÄ± etrafÄ±nda
            Lng = 28.9784 + ($i * 0.001)
        }
    }

    $prefetchedTiles = 0
    $zoomLevels = @(10, 12, 15)

    foreach ($point in $routePoints) {
        foreach ($zoom in $zoomLevels) {
            # Tile koordinatlarÄ±nÄ± hesapla (basitleÅŸtirilmiÅŸ)
            $tileX = [math]::Floor(($point.Lng + 180) / 360 * [math]::Pow(2, $zoom))
            $tileY = [math]::Floor((1 - [math]::Log([math]::Tan($point.Lat * [math]::PI / 180) + 1 / [math]::Cos($point.Lat * [math]::PI / 180)) / [math]::PI) / 2 * [math]::Pow(2, $zoom))

            $tileKey = "$zoom/$tileX/$tileY"

            # Prefetch simÃ¼lasyonu
            Write-ColorOutput "    ğŸ“¦ Prefetching tile: $tileKey" "Gray"
            $prefetchedTiles++

            # KÄ±sa bir gecikme ekle (aÄŸ Ã§aÄŸrÄ±sÄ± simÃ¼lasyonu)
            Start-Sleep -Milliseconds 10
        }
    }

    $prefetchEndTime = Get-Date
    $prefetchDuration = $prefetchEndTime - $prefetchStartTime

    Write-ColorOutput "    ğŸ“Š Prefetch Ä°statistikleri:" "Gray"
    Write-ColorOutput "      - Prefetch Edilen Tile: $prefetchedTiles" "Gray"
    Write-ColorOutput "      - SÃ¼re: $([math]::Round($prefetchDuration.TotalSeconds, 2)) saniye" "Gray"
    Write-ColorOutput "      - Saniye BaÅŸÄ±na Tile: $([math]::Round($prefetchedTiles / $prefetchDuration.TotalSeconds, 1))" "Gray"

    # Test sonuÃ§larÄ±nÄ± gÃ¼ncelle
    $testResults.PrefetchStats.TilesPrefetched = $prefetchedTiles
    $testResults.PrefetchStats.PrefetchDuration = $prefetchDuration
    $testResults.PrefetchStats.CacheHitRate = 0.75 # Mock cache hit rate

    if ($prefetchedTiles -gt 0) {
        Write-ColorOutput "    âœ… Tile prefetch baÅŸarÄ±lÄ±" "Green"
    } else {
        Write-ColorOutput "    âŒ Prefetch baÅŸarÄ±sÄ±z" "Red"
        throw "Tile prefetch failed"
    }
}

# Cache temizleme testi
function Test-CacheCleanup {
    Write-ColorOutput "  ğŸ§¹ Cache temizleme testi baÅŸlatÄ±lÄ±yor..." "Gray"

    $fullCachePath = Join-Path $ProjectPath $CachePath
    $fullCompressedPath = Join-Path $ProjectPath $CompressedPath

    # Eski test dosyalarÄ± oluÅŸtur
    $oldFiles = @()
    $oldDate = (Get-Date).AddDays(-8) # 8 gÃ¼n Ã¶nce

    for ($i = 1; $i -le 5; $i++) {
        $oldFileName = "old-tile-$i.tile"
        $oldFilePath = Join-Path $fullCompressedPath $oldFileName
        "old test data $i" | Out-File $oldFilePath -Encoding UTF8
        (Get-Item $oldFilePath).LastWriteTime = $oldDate
        $oldFiles += $oldFilePath
    }

    # Yeni test dosyasÄ± oluÅŸtur
    $newFileName = "new-tile.tile"
    $newFilePath = Join-Path $fullCompressedPath $newFileName
    "new test data" | Out-File $newFilePath -Encoding UTF8

    Write-ColorOutput "    ğŸ“… Eski dosyalar oluÅŸturuldu: $($oldFiles.Count)" "Gray"
    Write-ColorOutput "    ğŸ“… Yeni dosya oluÅŸturuldu: $newFileName" "Gray"

    # Eski dosyalarÄ± temizle (7 gÃ¼nden eski)
    $retentionDays = 7
    $cutoffDate = (Get-Date).AddDays(-$retentionDays)

    $filesToDelete = Get-ChildItem $fullCompressedPath -Filter "*.tile" |
        Where-Object { $_.LastWriteTime -lt $cutoffDate }

    $deletedCount = 0
    foreach ($file in $filesToDelete) {
        Remove-Item $file.FullName -Force
        $deletedCount++
        Write-ColorOutput "    âœ… Eski dosya silindi: $($file.Name)" "Green"
    }

    # Yeni dosyanÄ±n kaldÄ±ÄŸÄ±nÄ± kontrol et
    if (Test-Path $newFilePath) {
        Write-ColorOutput "    âœ… Yeni dosya korundu" "Green"
    } else {
        Write-ColorOutput "    âŒ Yeni dosya yanlÄ±ÅŸlÄ±kla silindi" "Red"
    }

    Write-ColorOutput "    ğŸ“Š Temizleme Ä°statistikleri:" "Gray"
    Write-ColorOutput "      - Silinen Dosya: $deletedCount" "Gray"
    Write-ColorOutput "      - Korunan Dosya: 1" "Gray"
}

# YardÄ±mcÄ± fonksiyonlar
function Compress-TileData {
    param([byte[]]$data)

    $memoryStream = New-Object System.IO.MemoryStream
    $gzipStream = New-Object System.IO.Compression.GZipStream($memoryStream, [System.IO.Compression.CompressionMode]::Compress)
    $gzipStream.Write($data, 0, $data.Length)
    $gzipStream.Close()
    return $memoryStream.ToArray()
}

function Decompress-TileData {
    param([byte[]]$compressedData)

    $inputStream = New-Object System.IO.MemoryStream($compressedData)
    $outputStream = New-Object System.IO.MemoryStream
    $gzipStream = New-Object System.IO.Compression.GZipStream($inputStream, [System.IO.Compression.CompressionMode]::Decompress)
    $gzipStream.CopyTo($outputStream)
    $gzipStream.Close()
    return $outputStream.ToArray()
}

function Get-CompressedTilePath {
    param([string]$tileKey, [string]$compressedPath)

    $parts = $tileKey -split "/"
    if ($parts.Length -ge 3) {
        $z = $parts[0]
        $x = $parts[1].PadLeft(4, '0')
        $y = $parts[2].PadLeft(4, '0')

        $tilePath = Join-Path $compressedPath $z
        $tilePath = Join-Path $tilePath $x.Substring(0, 2)
        $tilePath = Join-Path $tilePath $x.Substring(2, 2)
        $tilePath = Join-Path $tilePath "$x_$y.tile"

        return $tilePath
    }

    return Join-Path $compressedPath "$($tileKey -replace '/', '_').tile"
}

# Ana test dÃ¶ngÃ¼sÃ¼
Write-ColorOutput "ğŸš€ Tile optimizasyon testleri baÅŸlatÄ±lÄ±yor..." "White"
Write-ColorOutput ""

# Testleri Ã§alÄ±ÅŸtÄ±r
Test-TileOptimization -TestName "Cache KlasÃ¶rÃ¼ Kurulumu" -TestScript { Test-CacheDirectorySetup }
Test-TileOptimization -TestName "Tile SÄ±kÄ±ÅŸtÄ±rma" -TestScript { Test-TileCompression }
Test-TileOptimization -TestName "Tile AÃ§ma" -TestScript { Test-TileDecompression }
Test-TileOptimization -TestName "Tile Prefetch" -TestScript { Test-TilePrefetch }
Test-TileOptimization -TestName "Cache Temizleme" -TestScript { Test-CacheCleanup }

# Test Ã¶zeti
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           ğŸ“Š Test SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$successRate = if ($testResults.TotalTests -gt 0) {
    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)
} else { 0 }

Write-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"
Write-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"
Write-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"
Write-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"
Write-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"

# SÄ±kÄ±ÅŸtÄ±rma istatistikleri
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "        ğŸ—œï¸ SÄ±kÄ±ÅŸtÄ±rma Ä°statistikleri" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

Write-ColorOutput "SÄ±kÄ±ÅŸtÄ±rÄ±lan Tile: $($testResults.CompressionStats.TilesCompressed)" "White"
Write-ColorOutput "Orijinal Boyut: $([math]::Round($testResults.CompressionStats.OriginalSize/1024, 2)) KB" "White"
Write-ColorOutput "SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ Boyut: $([math]::Round($testResults.CompressionStats.CompressedSize/1024, 2)) KB" "White"
Write-ColorOutput "SÄ±kÄ±ÅŸtÄ±rma OranÄ±: $([math]::Round($testResults.CompressionStats.CompressionRatio, 3))" "Cyan"
Write-ColorOutput "Alan Tasarrufu: $([math]::Round(($testResults.CompressionStats.OriginalSize - $testResults.CompressionStats.CompressedSize)/1024, 2)) KB" "Green"

# Prefetch istatistikleri
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "        ğŸš€ Prefetch Ä°statistikleri" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

Write-ColorOutput "Prefetch Edilen Tile: $($testResults.PrefetchStats.TilesPrefetched)" "White"
Write-ColorOutput "Prefetch SÃ¼resi: $([math]::Round($testResults.PrefetchStats.PrefetchDuration.TotalSeconds, 2)) saniye" "White"
Write-ColorOutput "Cache Hit Rate: $([math]::Round($testResults.PrefetchStats.CacheHitRate * 100, 1))%" "Cyan"

# DetaylÄ± sonuÃ§lar
if ($Verbose) {
    Write-ColorOutput "" "White"
    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"
    foreach ($detail in $testResults.Details) {
        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }
        Write-ColorOutput "  $status $($detail.TestName)" "White"
        if (!$detail.Passed -and $detail.ErrorMessage) {
            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"
        }
    }
}

# JSON export
if ($ExportJson) {
    $jsonPath = Join-Path $ProjectPath "tile-optimization-test-results.json"
    $exportData = @{
        metadata = @{
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            script_version = "1.0.0"
            test_environment = $TestEnvironment
            cache_path = $CachePath
            compressed_path = $CompressedPath
            test_tile_count = $TestTileCount
            compression_level = $CompressionLevel
            total_duration_seconds = $testResults.TestDuration.TotalSeconds
        }
        summary = @{
            total_tests = $testResults.TotalTests
            passed_tests = $testResults.PassedTests
            failed_tests = $testResults.FailedTests
            success_rate = $successRate
        }
        compression_stats = $testResults.CompressionStats
        prefetch_stats = $testResults.PrefetchStats
        details = $testResults.Details
        recommendations = @(
            "SÄ±kÄ±ÅŸtÄ±rma seviyesini artÄ±rarak daha fazla alan tasarrufu saÄŸlayÄ±n",
            "Prefetch radius'Ä±nÄ± artÄ±rarak daha iyi offline deneyim sunun",
            "Cache temizleme periyodunu optimize edin",
            "Paralel indirme sayÄ±sÄ±nÄ± artÄ±rarak prefetch hÄ±zÄ±nÄ± iyileÅŸtirin",
            "Tile boyut limitlerini kullanÄ±m paternlerine gÃ¶re ayarlayÄ±n"
        )
    }

    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
    Write-ColorOutput "ğŸ“„ Test sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"
}

# Badge tetikleme
if ($testResults.PassedTests -gt 0) {
    Show-Badge "Offline-Optimized"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($testResults.FailedTests -eq 0) {
    Write-ColorOutput "ğŸ‰ Tile optimizasyon testleri baÅŸarÄ±lÄ±! Offline sistem hazÄ±r." "Green"
    exit 0
} else {
    Write-ColorOutput "ğŸ’¥ BazÄ± tile optimizasyon testleri baÅŸarÄ±sÄ±z oldu." "Red"
    exit 1
}

# Badge gÃ¶sterme fonksiyonu
function Show-Badge {
    param([string]$BadgeName)

    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"

    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)
    $badgeFile = Join-Path $ProjectPath "badge.json"
    if (Test-Path $badgeFile) {
        try {
            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json
            if ($badgeData.PSObject.Properties.Name -notcontains $BadgeName) {
                $badgeData | Add-Member -MemberType NoteProperty -Name $BadgeName -Value $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            } else {
                $badgeData.$BadgeName = $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            }
        } catch {
            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"
        }
    } else {
        # Yeni badge dosyasÄ± oluÅŸtur
        $newBadgeData = @{
            $BadgeName = $true
        }
        $newBadgeData | ConvertTo-Json | Set-Content $badgeFile
        Write-ColorOutput "  âœ… Yeni badge dosyasÄ± oluÅŸturuldu" "Green"
    }
}
