# Test-RoutingFallback.ps1 - CI/CD pipeline ile entegre global routing fallback testi\n# Bu script routing fallback zincirini test eder: HERE â†’ Mapbox â†’ Google â†’ Offline\n\nparam(\n    [string]$TestEnvironment = "local",\n    [string]$Configuration = "Debug",\n    [string]$ProjectPath = $PSScriptRoot,\n    [switch]$SkipBuild,\n    [switch]$Verbose,\n    [switch]$ExportJson\n)\n\n# Script ayarlarÄ±\n$ErrorActionPreference = "Stop"\n$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }\n\n# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler\n$testResults = @{\n    TotalTests = 0\n    PassedTests = 0\n    FailedTests = 0\n    TestDuration = [TimeSpan]::Zero\n    Details = @()\n}\n\n# Renkli output iÃ§in\nfunction Write-ColorOutput {\n    param(\n        [string]$Message,\n        [string]$Color = "White"\n    )\n    Write-Host $Message -ForegroundColor $Color\n}\n\n# BaÅŸlÄ±k\nWrite-ColorOutput "=========================================" "Cyan"\nWrite-ColorOutput "    ğŸŒ Global Routing Fallback Testi" "Cyan"\nWrite-ColorOutput "=========================================" "Cyan"\nWrite-ColorOutput ""\n\n# Environment deÄŸiÅŸkenlerini ayarla\n$env:TEST_ENVIRONMENT = $TestEnvironment\n$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }\n$env:DOTNET_ENVIRONMENT = if ($TestEnvironment -eq "ci") { "Production" } else { "Development" }\n\n# Test koordinatlarÄ±\n$testCoordinates = @(\n    @{ From = @{ Lat = 41.0082; Lng = 28.9784 }; To = @{ Lat = 39.9334; Lng = 32.8597 }; Name = "Ä°stanbul-Ankara" },\n    @{ From = @{ Lat = 40.1885; Lng = 29.0610 }; To = @{ Lat = 39.7667; Lng = 30.5250 }; Name = "Bursa-KÃ¼tahya" },\n    @{ From = @{ Lat = 38.4192; Lng = 27.1287 }; To = @{ Lat = 37.8714; Lng = 32.4844 }; Name = "Ä°zmir-Konya" }\n)\n\nWrite-ColorOutput "Test Environment: $TestEnvironment" "Yellow"\nWrite-ColorOutput "Configuration: $Configuration" "Yellow"\nWrite-ColorOutput "Test KoordinatlarÄ±: $($testCoordinates.Count) adet" "Yellow"\nWrite-ColorOutput ""\n\n# Proje yolunu kontrol et\nif (!(Test-Path $ProjectPath)) {\n    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"\n    exit 1\n}\n\n# .NET SDK kontrolÃ¼\nWrite-ColorOutput "ğŸ” .NET SDK kontrol ediliyor..." "White"\ntry {\n    $dotnetVersion = dotnet --version\n    Write-ColorOutput "âœ… .NET SDK bulundu: $dotnetVersion" "Green"\n} catch {\n    Write-ColorOutput "âŒ .NET SDK bulunamadÄ±. LÃ¼tfen .NET SDK yÃ¼kleyin." "Red"\n    exit 1\n}\n\n# Build iÅŸlemi\nif (!$SkipBuild) {\n    Write-ColorOutput "ğŸ”¨ Proje build ediliyor..." "White"\n    try {\n        Push-Location $ProjectPath\n        dotnet build --configuration $Configuration --verbosity minimal\n        Write-ColorOutput "âœ… Build baÅŸarÄ±lÄ±" "Green"\n    } catch {\n        Write-ColorOutput "âŒ Build baÅŸarÄ±sÄ±z: $($_.Exception.Message)" "Red"\n        exit 1\n    } finally {\n        Pop-Location\n    }\n} else {\n    Write-ColorOutput "â­ï¸  Build atlandÄ±" "Yellow"\n}\n\n# Test fonksiyonlarÄ±\nfunction Test-RoutingFallback {\n    param(\n        [hashtable]$From,\n        [hashtable]$To,\n        [string]$TestName\n    )\n\n    Write-ColorOutput "ğŸ§ª $TestName iÃ§in routing fallback testi baÅŸlatÄ±lÄ±yor..." "White"\n\n    $startTime = Get-Date\n    $testPassed = $false\n    $fallbackUsed = $false\n    $errorMessage = ""\n\n    try {\n        # RoutingService test simÃ¼lasyonu\n        Write-ColorOutput "  ğŸ“ BaÅŸlangÄ±Ã§: ($($From.Lat), $($From.Lng))" "Gray"\n        Write-ColorOutput "  ğŸ¯ Hedef: ($($To.Lat), $($To.Lng))" "Gray"\n\n        # Provider zinciri testi\n        $providers = @("HERE Maps", "Mapbox", "Google Maps", "Offline")\n        $successfulProvider = $null\n\n        foreach ($provider in $providers) {\n            Write-ColorOutput "  ğŸ”„ $provider deneniyor..." "Gray"\n\n            # SimÃ¼le edilmiÅŸ provider testi\n            $isSuccess = Test-Provider $provider $From $To\n\n            if ($isSuccess) {\n                $successfulProvider = $provider\n                Write-ColorOutput "  âœ… $provider baÅŸarÄ±lÄ±!" "Green"\n                break\n            } else {\n                Write-ColorOutput "  âŒ $provider baÅŸarÄ±sÄ±z, fallback devam ediyor..." "Yellow"\n                $fallbackUsed = $true\n            }\n\n            # KÄ±sa bekleme simÃ¼lasyonu\n            Start-Sleep -Milliseconds 200\n        }\n\n        if ($successfulProvider) {\n            $testPassed = $true\n            Write-ColorOutput "  ğŸ‰ Test baÅŸarÄ±lÄ±: $successfulProvider kullanÄ±larak rota hesaplandÄ±" "Green"\n\n            if ($fallbackUsed) {\n                Write-ColorOutput "  ğŸ… Fallback sistemi Ã§alÄ±ÅŸtÄ±!" "Cyan"\n            }\n        } else {\n            $errorMessage = "TÃ¼m provider'lar baÅŸarÄ±sÄ±z oldu"\n            Write-ColorOutput "  ğŸ’¥ Test baÅŸarÄ±sÄ±z: $errorMessage" "Red"\n        }\n\n    } catch {\n        $errorMessage = $_.Exception.Message\n        Write-ColorOutput "  ğŸ’¥ Test hatasÄ±: $errorMessage" "Red"\n    } finally {\n        $endTime = Get-Date\n        $duration = $endTime - $startTime\n\n        $testResults.TotalTests++\n        if ($testPassed) {\n            $testResults.PassedTests++\n        } else {\n            $testResults.FailedTests++\n        }\n        $testResults.TestDuration += $duration\n\n        $testResults.Details += @{\n            TestName = $TestName\n            Passed = $testPassed\n            Duration = $duration\n            FallbackUsed = $fallbackUsed\n            SuccessfulProvider = $successfulProvider\n            ErrorMessage = $errorMessage\n        }\n    }\n}\n\nfunction Test-Provider {\n    param(\n        [string]$Provider,\n        [hashtable]$From,\n        [hashtable]$To\n    )\n\n    # Provider baÅŸarÄ± simÃ¼lasyonu\n    switch ($Provider) {\n        "HERE Maps" {\n            # HERE Maps API key kontrolÃ¼\n            $apiKey = $env:HERE_MAPS_API_KEY\n            if (!$apiKey -or $apiKey -eq "YOUR_HERE_API_KEY") {\n                return $false\n            }\n            # Rastgele baÅŸarÄ±/baÅŸarÄ±sÄ±zlÄ±k (%80 baÅŸarÄ±)\n            return (Get-Random -Maximum 100) -lt 80\n        }\n        "Mapbox" {\n            $apiKey = $env:MAPBOX_API_KEY\n            if (!$apiKey -or $apiKey -eq "YOUR_MAPBOX_API_KEY") {\n                return $false\n            }\n            return (Get-Random -Maximum 100) -lt 85\n        }\n        "Google Maps" {\n            $apiKey = $env:GOOGLE_MAPS_API_KEY\n            if (!$apiKey -or $apiKey -eq "YOUR_GOOGLE_API_KEY") {\n                return $false\n            }\n            return (Get-Random -Maximum 100) -lt 90\n        }\n        "Offline" {\n            # Offline her zaman baÅŸarÄ±lÄ±\n            return $true\n        }\n        default {\n            return $false\n        }\n    }\n}\n\nfunction Show-Badge {\n    param([string]$BadgeName)\n\n    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"\n\n    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)\n    $badgeFile = Join-Path $ProjectPath "badge.json"\n    if (Test-Path $badgeFile) {\n        try {\n            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json\n            if ($badgeData.PSObject.Properties.Name -contains $BadgeName) {\n                $badgeData.$BadgeName = $true\n                $badgeData | ConvertTo-Json | Set-Content $badgeFile\n                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"\n            }\n        } catch {\n            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"\n        }\n    }\n}\n\n# Ana test dÃ¶ngÃ¼sÃ¼\nWrite-ColorOutput "ğŸš€ Routing fallback testleri baÅŸlatÄ±lÄ±yor..." "White"\nWrite-ColorOutput ""\n\nforeach ($coord in $testCoordinates) {\n    Test-RoutingFallback -From $coord.From -To $coord.To -TestName $coord.Name\n    Write-ColorOutput ""\n}\n\n# Test Ã¶zeti\nWrite-ColorOutput "=========================================" "Cyan"\nWrite-ColorOutput "           ğŸ“Š Test SonuÃ§larÄ±" "Cyan"\nWrite-ColorOutput "=========================================" "Cyan"\n\n$successRate = if ($testResults.TotalTests -gt 0) {\n    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)\n} else { 0 }\n\nWrite-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"\nWrite-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"\nWrite-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"\nWrite-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"\nWrite-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"\n\n# DetaylÄ± sonuÃ§lar\nif ($Verbose) {\n    Write-ColorOutput "" "White"\n    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"\n    foreach ($detail in $testResults.Details) {\n        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }\n        $fallback = if ($detail.FallbackUsed) { " (Fallback)" } else { "" }\n        Write-ColorOutput "  $status $($detail.TestName): $($detail.Duration.TotalMilliseconds)ms$fallback" "White"\n        if (!$detail.Passed -and $detail.ErrorMessage) {\n            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"\n        }\n    }\n}\n\n# JSON export\nif ($ExportJson) {\n    $jsonPath = Join-Path $ProjectPath "routing-fallback-test-results.json"\n    $exportData = @{\n        metadata = @{\n            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")\n            script_version = "1.0.0"\n            test_environment = $TestEnvironment\n            total_duration_seconds = $testResults.TestDuration.TotalSeconds\n        }\n        summary = @{\n            total_tests = $testResults.TotalTests\n            passed_tests = $testResults.PassedTests\n            failed_tests = $testResults.FailedTests\n            success_rate = $successRate\n            test_duration = $testResults.TestDuration.ToString()\n        }\n        details = $testResults.Details\n        recommendations = @(\n            "HERE Maps API key'inin doÄŸru yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±ndan emin olun",\n            "Mapbox API key'inin doÄŸru yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±ndan emin olun",\n            "Google Maps API key'inin doÄŸru yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±ndan emin olun",\n            "Offline routing'in her zaman fallback olarak kullanÄ±labilir olduÄŸundan emin olun"\n        )\n    }\n\n    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath\n    Write-ColorOutput "ğŸ“„ Test sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"\n}\n\n# Badge tetikleme\nif ($testResults.PassedTests -gt 0) {\n    Show-Badge "Routing-Fallback"\n}\n\n# Final sonuÃ§\nWrite-ColorOutput "" "White"\nif ($testResults.FailedTests -eq 0) {\n    Write-ColorOutput "ğŸ‰ TÃ¼m routing fallback testleri baÅŸarÄ±lÄ±! CI/CD pipeline devam edebilir." "Green"\n    exit 0\n} else {\n    Write-ColorOutput "ğŸ’¥ BazÄ± routing fallback testleri baÅŸarÄ±sÄ±z. LÃ¼tfen hatalarÄ± dÃ¼zeltin." "Red"\n    exit 1\n}\n