# AuditLegal.ps1 - Legal auto-audit scripti
# Bu script yasal dosyalarÄ± otomatik olarak doÄŸrular ve CI/CD pipeline ile entegre Ã§alÄ±ÅŸÄ±r

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose,
    [switch]$ExportJson,
    [string]$LegalPath = ".\legal",
    [string]$PrivacyPolicyFile = "privacy-policy.md",
    [string]$TermsOfServiceFile = "terms-of-service.md",
    [string]$LicenseFile = "LICENSE"
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler
$testResults = @{
    TotalTests = 0
    PassedTests = 0
    FailedTests = 0
    TestDuration = [TimeSpan]::Zero
    Details = @()
}

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:LEGAL_PATH = $LegalPath
$env:PRIVACY_POLICY_FILE = $PrivacyPolicyFile
$env:TERMS_OF_SERVICE_FILE = $TermsOfServiceFile
$env:LICENSE_FILE = $LicenseFile

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "      ğŸ” Legal Auto-Audit Sistemi" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# Test fonksiyonlarÄ±
function Test-LegalAudit {
    param(
        [string]$TestName,
        [scriptblock]$TestScript
    )

    $startTime = Get-Date
    $testPassed = $false
    $errorMessage = ""

    Write-ColorOutput "ğŸ§ª $TestName testi baÅŸlatÄ±lÄ±yor..." "White"

    try {
        & $TestScript
        $testPassed = $true
        Write-ColorOutput "  âœ… $TestName testi baÅŸarÄ±lÄ±" "Green"
    } catch {
        $errorMessage = $_.Exception.Message
        Write-ColorOutput "  âŒ $TestName testi baÅŸarÄ±sÄ±z: $errorMessage" "Red"
    } finally {
        $endTime = Get-Date
        $duration = $endTime - $startTime

        $testResults.TotalTests++
        if ($testPassed) {
            $testResults.PassedTests++
        } else {
            $testResults.FailedTests++
        }
        $testResults.TestDuration += $duration

        $testResults.Details += @{
            TestName = $TestName
            Passed = $testPassed
            Duration = $duration
            ErrorMessage = $errorMessage
        }
    }
}

# Yasal klasÃ¶r yapÄ±sÄ± kontrolÃ¼
function Test-LegalDirectoryStructure {
    Write-ColorOutput "  ğŸ“ Yasal klasÃ¶r yapÄ±sÄ± kontrol ediliyor..." "Gray"

    $legalFullPath = Join-Path $ProjectPath $LegalPath

    if (!(Test-Path $legalFullPath)) {
        Write-ColorOutput "    ğŸ“‚ Yasal klasÃ¶r oluÅŸturuluyor: $legalFullPath" "Gray"
        New-Item -ItemType Directory -Path $legalFullPath -Force | Out-Null
    } else {
        Write-ColorOutput "    âœ… Yasal klasÃ¶r mevcut: $legalFullPath" "Green"
    }

    # Alt klasÃ¶rler kontrolÃ¼
    $subDirs = @("policies", "licenses", "compliance", "gdpr", "ccpa")
    foreach ($subDir in $subDirs) {
        $subDirPath = Join-Path $legalFullPath $subDir
        if (!(Test-Path $subDirPath)) {
            New-Item -ItemType Directory -Path $subDirPath -Force | Out-Null
            Write-ColorOutput "    ğŸ“‚ Alt klasÃ¶r oluÅŸturuldu: $subDir" "Gray"
        } else {
            Write-ColorOutput "    âœ… Alt klasÃ¶r mevcut: $subDir" "Green"
        }
    }
}

# Privacy Policy kontrolÃ¼
function Test-PrivacyPolicy {
    Write-ColorOutput "  ğŸ“‹ Privacy Policy kontrol ediliyor..." "Gray"

    $privacyPolicyPath = Join-Path $ProjectPath (Join-Path $LegalPath $PrivacyPolicyFile)

    if (Test-Path $privacyPolicyPath) {
        Write-ColorOutput "    âœ… Privacy Policy dosyasÄ± bulundu: $PrivacyPolicyFile" "Green"

        # Dosya iÃ§eriÄŸi kontrolÃ¼
        $content = Get-Content $privacyPolicyPath -Raw

        # Gerekli bÃ¶lÃ¼mler kontrolÃ¼
        $requiredSections = @(
            "Data Collection",
            "Data Usage",
            "Data Sharing",
            "User Rights",
            "Contact Information",
            "Last Updated"
        )

        $foundSections = 0
        foreach ($section in $requiredSections) {
            if ($content -match $section) {
                $foundSections++
            }
        }

        Write-ColorOutput "    ğŸ“Š Bulunan bÃ¶lÃ¼mler: $foundSections/$($requiredSections.Count)" "Gray"

        if ($foundSections -ge ($requiredSections.Count * 0.8)) {
            Write-ColorOutput "    âœ… Privacy Policy iÃ§eriÄŸi yeterli" "Green"
        } else {
            Write-ColorOutput "    âš ï¸  Privacy Policy iÃ§eriÄŸi eksik bÃ¶lÃ¼mler iÃ§eriyor" "Yellow"
        }

        # Dosya boyutu kontrolÃ¼
        $fileSize = (Get-Item $privacyPolicyPath).Length
        Write-ColorOutput "    ğŸ“„ Dosya boyutu: $([math]::Round($fileSize/1024, 1)) KB" "Gray"

        if ($fileSize -lt 1024) { # 1KB'den kÃ¼Ã§Ã¼kse uyarÄ±
            Write-ColorOutput "    âš ï¸  Privacy Policy dosyasÄ± Ã§ok kÃ¼Ã§Ã¼k" "Yellow"
        }

    } else {
        Write-ColorOutput "    âŒ Privacy Policy dosyasÄ± bulunamadÄ±: $PrivacyPolicyFile" "Red"
        Write-ColorOutput "    ğŸ“ Ã–rnek Privacy Policy oluÅŸturuluyor..." "Gray"

        # Ã–rnek Privacy Policy oluÅŸtur
        $samplePrivacyPolicy = @"
# Privacy Policy

## Last Updated: $(Get-Date -Format "yyyy-MM-dd")

## Data Collection
We collect information you provide directly to us...

## Data Usage
We use the information we collect to...

## Data Sharing
We do not sell, trade, or otherwise transfer your personal information...

## User Rights
You have the right to access, update, or delete your personal information...

## Contact Information
If you have any questions about this Privacy Policy, please contact us at:
- Email: privacy@example.com
- Address: [Your Address]

## Changes to This Policy
We may update this Privacy Policy from time to time...
"@

        $samplePrivacyPolicy | Out-File $privacyPolicyPath -Encoding UTF8
        Write-ColorOutput "    âœ… Ã–rnek Privacy Policy oluÅŸturuldu" "Green"
    }
}

# Terms of Service kontrolÃ¼
function Test-TermsOfService {
    Write-ColorOutput "  ğŸ“œ Terms of Service kontrol ediliyor..." "Gray"

    $termsPath = Join-Path $ProjectPath (Join-Path $LegalPath $TermsOfServiceFile)

    if (Test-Path $termsPath) {
        Write-ColorOutput "    âœ… Terms of Service dosyasÄ± bulundu: $TermsOfServiceFile" "Green"

        # Dosya iÃ§eriÄŸi kontrolÃ¼
        $content = Get-Content $termsPath -Raw

        # Gerekli bÃ¶lÃ¼mler kontrolÃ¼
        $requiredSections = @(
            "Acceptance of Terms",
            "Use License",
            "User Obligations",
            "Prohibited Uses",
            "Termination",
            "Disclaimer",
            "Limitation of Liability",
            "Governing Law"
        )

        $foundSections = 0
        foreach ($section in $requiredSections) {
            if ($content -match $section) {
                $foundSections++
            }
        }

        Write-ColorOutput "    ğŸ“Š Bulunan bÃ¶lÃ¼mler: $foundSections/$($requiredSections.Count)" "Gray"

        if ($foundSections -ge ($requiredSections.Count * 0.8)) {
            Write-ColorOutput "    âœ… Terms of Service iÃ§eriÄŸi yeterli" "Green"
        } else {
            Write-ColorOutput "    âš ï¸  Terms of Service iÃ§eriÄŸi eksik bÃ¶lÃ¼mler iÃ§eriyor" "Yellow"
        }

    } else {
        Write-ColorOutput "    âŒ Terms of Service dosyasÄ± bulunamadÄ±: $TermsOfServiceFile" "Red"
        Write-ColorOutput "    ğŸ“ Ã–rnek Terms of Service oluÅŸturuluyor..." "Gray"

        # Ã–rnek Terms of Service oluÅŸtur
        $sampleTerms = @"
# Terms of Service

## Last Updated: $(Get-Date -Format "yyyy-MM-dd")

## Acceptance of Terms
By accessing and using this application, you accept and agree to be bound by the terms...

## Use License
Subject to these Terms, we grant you a limited, non-exclusive, non-transferable license...

## User Obligations
You agree to use the application only for lawful purposes...

## Prohibited Uses
You may not use the application for any illegal or unauthorized purpose...

## Termination
We may terminate or suspend your account immediately, without prior notice...

## Disclaimer
The application is provided on an "AS IS" and "AS AVAILABLE" basis...

## Limitation of Liability
In no event shall we be liable for any indirect, incidental, special, consequential...

## Governing Law
These Terms shall be interpreted and governed by the laws of [Your Jurisdiction]...

## Contact Information
If you have any questions about these Terms, please contact us at:
- Email: legal@example.com
"@

        $sampleTerms | Out-File $termsPath -Encoding UTF8
        Write-ColorOutput "    âœ… Ã–rnek Terms of Service oluÅŸturuldu" "Green"
    }
}

# License dosyasÄ± kontrolÃ¼
function Test-LicenseFile {
    Write-ColorOutput "  ğŸ“„ License dosyasÄ± kontrol ediliyor..." "Gray"

    $licensePath = Join-Path $ProjectPath $LicenseFile

    if (Test-Path $licensePath) {
        Write-ColorOutput "    âœ… License dosyasÄ± bulundu: $LicenseFile" "Green"

        # Lisans tÃ¼rÃ¼ kontrolÃ¼
        $content = Get-Content $licensePath -Raw

        $licenseTypes = @(
            @{ Name = "MIT"; Pattern = "MIT License" },
            @{ Name = "Apache 2.0"; Pattern = "Apache License" },
            @{ Name = "GPL"; Pattern = "GNU General Public License" },
            @{ Name = "BSD"; Pattern = "BSD License" }
        )

        $detectedLicense = "Unknown"
        foreach ($license in $licenseTypes) {
            if ($content -match $license.Pattern) {
                $detectedLicense = $license.Name
                break
            }
        }

        Write-ColorOutput "    ğŸ“‹ Tespit edilen lisans: $detectedLicense" "Gray"

        # Lisans geÃ§erliliÄŸi kontrolÃ¼
        if ($content -match "Copyright" -and $content -match "Permission is hereby granted") {
            Write-ColorOutput "    âœ… Lisans geÃ§erli gÃ¶rÃ¼nÃ¼yor" "Green"
        } else {
            Write-ColorOutput "    âš ï¸  Lisans iÃ§eriÄŸi standart dÄ±ÅŸÄ±" "Yellow"
        }

    } else {
        Write-ColorOutput "    âŒ License dosyasÄ± bulunamadÄ±: $LicenseFile" "Red"
        Write-ColorOutput "    ğŸ“ MIT License oluÅŸturuluyor..." "Gray"

        # Ã–rnek MIT License oluÅŸtur
        $sampleLicense = @"
MIT License

Copyright (c) $(Get-Date -Format "yyyy") [Your Name or Company]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
"@

        $sampleLicense | Out-File $licensePath -Encoding UTF8
        Write-ColorOutput "    âœ… Ã–rnek MIT License oluÅŸturuldu" "Green"
    }
}

# GDPR uyumluluk kontrolÃ¼
function Test-GDPRCompliance {
    Write-ColorOutput "  ğŸ‡ªğŸ‡º GDPR uyumluluk kontrol ediliyor..." "Gray"

    $gdprPath = Join-Path $ProjectPath (Join-Path $LegalPath "gdpr")

    # GDPR gerekli dosyalar
    $gdprFiles = @(
        "data-processing-agreement.md",
        "data-retention-policy.md",
        "cookie-policy.md",
        "data-subject-rights.md"
    )

    $existingFiles = 0
    foreach ($file in $gdprFiles) {
        $filePath = Join-Path $gdprPath $file
        if (Test-Path $filePath) {
            $existingFiles++
            Write-ColorOutput "    âœ… $file mevcut" "Green"
        } else {
            Write-ColorOutput "    âŒ $file eksik" "Red"
        }
    }

    Write-ColorOutput "    ğŸ“Š GDPR dosyalarÄ±: $existingFiles/$($gdprFiles.Count)" "Gray"

    if ($existingFiles -ge ($gdprFiles.Count * 0.5)) {
        Write-ColorOutput "    âœ… GDPR uyumluluk yeterli" "Green"
    } else {
        Write-ColorOutput "    âš ï¸  GDPR uyumluluk eksik" "Yellow"
    }
}

# Yasal dosya gÃ¼ncellik kontrolÃ¼
function Test-LegalFileFreshness {
    Write-ColorOutput "  ğŸ“… Yasal dosya gÃ¼ncellik kontrol ediliyor..." "Gray"

    $legalFiles = @(
        @{ Path = Join-Path $LegalPath $PrivacyPolicyFile; Name = "Privacy Policy" },
        @{ Path = Join-Path $LegalPath $TermsOfServiceFile; Name = "Terms of Service" },
        @{ Path = $LicenseFile; Name = "License" }
    )

    $maxAgeDays = 365  # 1 yÄ±l

    foreach ($file in $legalFiles) {
        $filePath = Join-Path $ProjectPath $file.Path

        if (Test-Path $filePath) {
            $fileInfo = Get-Item $filePath
            $age = (Get-Date) - $fileInfo.LastWriteTime
            $ageDays = $age.TotalDays

            Write-ColorOutput "    ğŸ“„ $($file.Name): $([math]::Round($ageDays, 0)) gÃ¼n Ã¶nce gÃ¼ncellendi" "Gray"

            if ($ageDays -gt $maxAgeDays) {
                Write-ColorOutput "    âš ï¸  $($file.Name) Ã§ok eski (>$maxAgeDays gÃ¼n)" "Yellow"
            } else {
                Write-ColorOutput "    âœ… $($file.Name) gÃ¼ncel" "Green"
            }
        }
    }
}

# Ana test dÃ¶ngÃ¼sÃ¼
Write-ColorOutput "ğŸš€ Legal auto-audit baÅŸlatÄ±lÄ±yor..." "White"
Write-ColorOutput ""

# Testleri Ã§alÄ±ÅŸtÄ±r
Test-LegalAudit -TestName "Yasal KlasÃ¶r YapÄ±sÄ±" -TestScript { Test-LegalDirectoryStructure }
Test-LegalAudit -TestName "Privacy Policy" -TestScript { Test-PrivacyPolicy }
Test-LegalAudit -TestName "Terms of Service" -TestScript { Test-TermsOfService }
Test-LegalAudit -TestName "License DosyasÄ±" -TestScript { Test-LicenseFile }
Test-LegalAudit -TestName "GDPR Uyumluluk" -TestScript { Test-GDPRCompliance }
Test-LegalAudit -TestName "Dosya GÃ¼ncellik" -TestScript { Test-LegalFileFreshness }

# Test Ã¶zeti
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           ğŸ“Š Audit SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$successRate = if ($testResults.TotalTests -gt 0) {
    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)
} else { 0 }

Write-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"
Write-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"
Write-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"
Write-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"
Write-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"

# DetaylÄ± sonuÃ§lar
if ($Verbose) {
    Write-ColorOutput "" "White"
    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"
    foreach ($detail in $testResults.Details) {
        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }
        Write-ColorOutput "  $status $($detail.TestName)" "White"
        if (!$detail.Passed -and $detail.ErrorMessage) {
            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"
        }
    }
}

# Yasal uyumluluk raporu
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "        ğŸ“‹ Yasal Uyumluluk Raporu" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$legalFiles = @(
    Join-Path $LegalPath $PrivacyPolicyFile,
    Join-Path $LegalPath $TermsOfServiceFile,
    $LicenseFile
)

$complianceScore = 0
$maxScore = $legalFiles.Count

foreach ($file in $legalFiles) {
    $filePath = Join-Path $ProjectPath $file
    if (Test-Path $filePath) {
        $complianceScore++
        Write-ColorOutput "âœ… $(Split-Path $file -Leaf) - Mevcut" "Green"
    } else {
        Write-ColorOutput "âŒ $(Split-Path $file -Leaf) - Eksik" "Red"
    }
}

$compliancePercentage = [math]::Round(($complianceScore / $maxScore) * 100, 1)
Write-ColorOutput "ğŸ“Š Yasal Uyumluluk Skoru: $complianceScore/$maxScore ($compliancePercentage%)" "Cyan"

# JSON export
if ($ExportJson) {
    $jsonPath = Join-Path $ProjectPath "legal-audit-results.json"
    $exportData = @{
        metadata = @{
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            script_version = "1.0.0"
            test_environment = $TestEnvironment
            legal_path = $LegalPath
            total_duration_seconds = $testResults.TestDuration.TotalSeconds
        }
        summary = @{
            total_tests = $testResults.TotalTests
            passed_tests = $testResults.PassedTests
            failed_tests = $testResults.FailedTests
            success_rate = $successRate
            compliance_score = $complianceScore
            compliance_percentage = $compliancePercentage
            test_duration = $testResults.TestDuration.ToString()
        }
        legal_files = @{
            privacy_policy = @{
                file = $PrivacyPolicyFile
                exists = Test-Path (Join-Path $ProjectPath (Join-Path $LegalPath $PrivacyPolicyFile))
            }
            terms_of_service = @{
                file = $TermsOfServiceFile
                exists = Test-Path (Join-Path $ProjectPath (Join-Path $LegalPath $TermsOfServiceFile))
            }
            license = @{
                file = $LicenseFile
                exists = Test-Path (Join-Path $ProjectPath $LicenseFile)
            }
        }
        details = $testResults.Details
        recommendations = @(
            "Privacy Policy ve Terms of Service dosyalarÄ±nÄ± oluÅŸturun",
            "Lisans dosyasÄ±nÄ± proje tÃ¼rÃ¼ne uygun olarak gÃ¼ncelleyin",
            "GDPR uyumluluk dosyalarÄ±nÄ± tamamlayÄ±n",
            "Yasal dosyalarÄ± yÄ±lda bir kez gÃ¶zden geÃ§irin",
            "Yasal deÄŸiÅŸiklikleri takip etmek iÃ§in monitoring sistemi kurun"
        )
    }

    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
    Write-ColorOutput "ğŸ“„ Audit sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"
}

# Badge tetikleme
if ($testResults.PassedTests -gt 0) {
    Show-Badge "Legal-Audited"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($testResults.FailedTests -eq 0) {
    Write-ColorOutput "ğŸ‰ Legal auto-audit baÅŸarÄ±lÄ±! TÃ¼m yasal dosyalar mevcut ve gÃ¼ncel." "Green"
    exit 0
} else {
    Write-ColorOutput "ğŸ’¥ Legal audit tamamlandÄ± ancak bazÄ± dosyalar eksik veya gÃ¼ncel deÄŸil." "Red"
    exit 1
}

# Badge gÃ¶sterme fonksiyonu
function Show-Badge {
    param([string]$BadgeName)

    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"

    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)
    $badgeFile = Join-Path $ProjectPath "badge.json"
    if (Test-Path $badgeFile) {
        try {
            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json
            if ($badgeData.PSObject.Properties.Name -notcontains $BadgeName) {
                $badgeData | Add-Member -MemberType NoteProperty -Name $BadgeName -Value $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            } else {
                $badgeData.$BadgeName = $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            }
        } catch {
            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"
        }
    } else {
        # Yeni badge dosyasÄ± oluÅŸtur
        $newBadgeData = @{
            $BadgeName = $true
        }
        $newBadgeData | ConvertTo-Json | Set-Content $badgeFile
        Write-ColorOutput "  âœ… Yeni badge dosyasÄ± oluÅŸturuldu" "Green"
    }
}
