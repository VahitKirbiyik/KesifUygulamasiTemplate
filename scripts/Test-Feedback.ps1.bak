# Test-Feedback.ps1 - Ã‡ok dilli geri bildirim testi
# Bu script geri bildirim sistemini test eder ve CI/CD pipeline ile entegre Ã§alÄ±ÅŸÄ±r

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose,
    [switch]$ExportJson,
    [string[]]$TestLanguages = @("en", "tr", "de", "fr", "es", "ar", "zh", "ja"),
    [int]$MaxFeedbacksPerDay = 100
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Test sonuÃ§larÄ± iÃ§in deÄŸiÅŸkenler
$testResults = @{
    TotalTests = 0
    PassedTests = 0
    FailedTests = 0
    TestDuration = [TimeSpan]::Zero
    Details = @()
}

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:AUTO_PROCESS_FEEDBACK = "true"
$env:MAX_FEEDBACKS_PER_DAY = $MaxFeedbacksPerDay.ToString()
$env:SUPPORTED_LANGUAGES = $TestLanguages -join ","

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "      ğŸŒ Ã‡ok Dilli Geri Bildirim Testi" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# Test fonksiyonlarÄ±
function Test-MultiLanguageFeedback {
    param(
        [string]$TestName,
        [scriptblock]$TestScript
    )

    $startTime = Get-Date
    $testPassed = $false
    $errorMessage = ""

    Write-ColorOutput "ğŸ§ª $TestName testi baÅŸlatÄ±lÄ±yor..." "White"

    try {
        & $TestScript
        $testPassed = $true
        Write-ColorOutput "  âœ… $TestName testi baÅŸarÄ±lÄ±" "Green"
    } catch {
        $errorMessage = $_.Exception.Message
        Write-ColorOutput "  âŒ $TestName testi baÅŸarÄ±sÄ±z: $errorMessage" "Red"
    } finally {
        $endTime = Get-Date
        $duration = $endTime - $startTime

        $testResults.TotalTests++
        if ($testPassed) {
            $testResults.PassedTests++
        } else {
            $testResults.FailedTests++
        }
        $testResults.TestDuration += $duration

        $testResults.Details += @{
            TestName = $TestName
            Passed = $testPassed
            Duration = $duration
            ErrorMessage = $errorMessage
        }
    }
}

# Dil desteÄŸi testi
function Test-LanguageSupport {
    Write-ColorOutput "  ğŸŒ Dil desteÄŸi test ediliyor..." "Gray"

    $supportedLanguages = $env:SUPPORTED_LANGUAGES -split ","
    Write-ColorOutput "    ğŸ“ Desteklenen diller: $($supportedLanguages -join ', ')" "Gray"

    # Her dil iÃ§in Ã¶rnek geri bildirim
    $sampleFeedbacks = @{
        "en" = "Great app! Love the navigation features."
        "tr" = "Harika uygulama! Navigasyon Ã¶zellikleri Ã§ok iyi."
        "de" = "Tolle App! Die Navigationsfunktionen sind super."
        "fr" = "Excellente application! J'adore les fonctions de navigation."
        "es" = "Â¡Excelente aplicaciÃ³n! Me encantan las funciones de navegaciÃ³n."
        "ar" = "ØªØ·Ø¨ÙŠÙ‚ Ø±Ø§Ø¦Ø¹! Ø£Ø­Ø¨ Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªÙ†Ù‚Ù„."
        "zh" = "å¾ˆæ£’çš„åº”ç”¨ï¼æˆ‘å–œæ¬¢å¯¼èˆªåŠŸèƒ½ã€‚"
        "ja" = "ç´ æ™´ã‚‰ã—ã„ã‚¢ãƒ—ãƒªï¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒå¥½ãã§ã™ã€‚"
    }

    $feedbackCount = 0
    foreach ($lang in $supportedLanguages) {
        if ($sampleFeedbacks.ContainsKey($lang)) {
            Write-ColorOutput "    âœ… $lang : $($sampleFeedbacks[$lang])" "Green"
            $feedbackCount++
        } else {
            Write-ColorOutput "    âš ï¸  $lang iÃ§in Ã¶rnek geri bildirim bulunamadÄ±" "Yellow"
        }
    }

    Write-ColorOutput "    ğŸ“Š Test edilen dil sayÄ±sÄ±: $feedbackCount" "Gray"
}

# Geri bildirim iÅŸleme testi
function Test-FeedbackProcessing {
    Write-ColorOutput "  ğŸ”„ Geri bildirim iÅŸleme test ediliyor..." "Gray"

    # Feedback veri klasÃ¶rÃ¼ kontrolÃ¼
    $feedbackDataPath = Join-Path $env:APPDATA "KesifUygulamasi\FeedbackData"
    if (!(Test-Path $feedbackDataPath)) {
        New-Item -ItemType Directory -Path $feedbackDataPath -Force | Out-Null
        Write-ColorOutput "    ğŸ“ Feedback veri klasÃ¶rÃ¼ oluÅŸturuldu" "Gray"
    }

    # Ã–rnek feedback dosyasÄ± oluÅŸtur
    $sampleFeedback = @{
        id = [guid]::NewGuid().ToString()
        language = "en"
        message = "Test feedback for CI/CD pipeline"
        category = "Testing"
        rating = 5
        timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
        userId = "TestUser"
        metadata = @{
            user_agent = "Test-Agent"
            platform = "CI/CD"
            app_version = "1.0.0"
        }
        isProcessed = $false
    }

    $feedbackFile = Join-Path $feedbackDataPath "feedback_test_$(Get-Date -Format 'yyyyMMdd_HHmmss').json"
    $sampleFeedback | ConvertTo-Json -Depth 10 | Set-Content $feedbackFile

    Write-ColorOutput "    ğŸ“„ Ã–rnek feedback dosyasÄ± oluÅŸturuldu: $feedbackFile" "Gray"

    # Ä°ÅŸlenmiÅŸ feedback kontrolÃ¼
    $processedFeedbacks = Get-ChildItem $feedbackDataPath -Filter "feedback_*.json" | Where-Object {
        $content = Get-Content $_.FullName -Raw | ConvertFrom-Json
        $content.isProcessed -eq $true
    }

    Write-ColorOutput "    âœ… Ä°ÅŸlenmiÅŸ feedback sayÄ±sÄ±: $($processedFeedbacks.Count)" "Green"
}

# GÃ¼nlÃ¼k limit testi
function Test-DailyLimit {
    Write-ColorOutput "  ğŸ“Š GÃ¼nlÃ¼k limit testi..." "Gray"

    $maxFeedbacks = [int]$env:MAX_FEEDBACKS_PER_DAY
    Write-ColorOutput "    ğŸ¯ Maksimum gÃ¼nlÃ¼k feedback: $maxFeedbacks" "Gray"

    # BugÃ¼nkÃ¼ feedback sayÄ±sÄ± kontrolÃ¼
    $today = Get-Date -Format "yyyy-MM-dd"
    $feedbackDataPath = Join-Path $env:APPDATA "KesifUygulamasi\FeedbackData"
    $todaysFeedbacks = Get-ChildItem $feedbackDataPath -Filter "feedback_*.json" | Where-Object {
        $fileName = $_.Name
        $fileDate = $fileName -replace "feedback_", "" -replace "_.*", ""
        $fileDate -eq $today
    }

    Write-ColorOutput "    ğŸ“… BugÃ¼nkÃ¼ feedback sayÄ±sÄ±: $($todaysFeedbacks.Count)" "Gray"

    if ($todaysFeedbacks.Count -lt $maxFeedbacks) {
        Write-ColorOutput "    âœ… GÃ¼nlÃ¼k limit aÅŸÄ±lmamÄ±ÅŸ" "Green"
    } else {
        Write-ColorOutput "    âš ï¸  GÃ¼nlÃ¼k limit aÅŸÄ±lmÄ±ÅŸ" "Yellow"
    }
}

# Duygu analizi testi
function Test-SentimentAnalysis {
    Write-ColorOutput "  ğŸ˜Š Duygu analizi testi..." "Gray"

    # Ã–rnek mesajlar
    $testMessages = @(
        @{ Message = "This app is amazing!"; ExpectedSentiment = "positive" },
        @{ Message = "Great navigation features"; ExpectedSentiment = "positive" },
        @{ Message = "This is terrible"; ExpectedSentiment = "negative" },
        @{ Message = "Bug in the application"; ExpectedSentiment = "negative" },
        @{ Message = "Works as expected"; ExpectedSentiment = "neutral" }
    )

    $positiveWords = @("good", "great", "excellent", "awesome", "love", "amazing")
    $negativeWords = @("bad", "poor", "terrible", "hate", "worst", "bug")

    foreach ($test in $testMessages) {
        $message = $test.Message.ToLower()
        $positiveCount = ($positiveWords | Where-Object { $message.Contains($_) }).Count
        $negativeCount = ($negativeWords | Where-Object { $message.Contains($_) }).Count
        $sentimentScore = $positiveCount - $negativeCount

        $actualSentiment = if ($sentimentScore -gt 0) { "positive" } elseif ($sentimentScore -lt 0) { "negative" } else { "neutral" }

        if ($actualSentiment -eq $test.ExpectedSentiment) {
            Write-ColorOutput "    âœ… '$($test.Message)' -> $actualSentiment" "Green"
        } else {
            Write-ColorOutput "    âŒ '$($test.Message)' -> $actualSentiment (beklenen: $($test.ExpectedSentiment))" "Red"
        }
    }
}

# Otomatik yanÄ±t testi
function Test-AutoResponse {
    Write-ColorOutput "  ğŸ¤– Otomatik yanÄ±t testi..." "Gray"

    # Dile gÃ¶re otomatik yanÄ±tlar
    $autoResponses = @{
        "en" = "Thank you for your feedback! We appreciate your input."
        "tr" = "Geri bildiriminiz iÃ§in teÅŸekkÃ¼r ederiz! GÃ¶rÃ¼ÅŸlerinizi deÄŸerli buluyoruz."
        "de" = "Vielen Dank fÃ¼r Ihr Feedback! Wir schÃ¤tzen Ihre Eingabe."
        "fr" = "Merci pour votre retour! Nous apprÃ©cions vos commentaires."
        "es" = "Â¡Gracias por sus comentarios! Apreciamos sus aportes."
        "ar" = "Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ! Ù†Ø­Ù† Ù†Ù‚Ø¯Ø± Ø¢Ø±Ø§Ø¡Ùƒ."
        "zh" = "æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼æˆ‘ä»¬é‡è§†æ‚¨çš„æ„è§ã€‚"
        "ja" = "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚ãªãŸã®æ„è¦‹ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚"
    }

    foreach ($lang in $TestLanguages) {
        if ($autoResponses.ContainsKey($lang)) {
            Write-ColorOutput "    âœ… $lang : $($autoResponses[$lang])" "Green"
        } else {
            Write-ColorOutput "    âš ï¸  $lang iÃ§in otomatik yanÄ±t bulunamadÄ±" "Yellow"
        }
    }
}

# Ana test dÃ¶ngÃ¼sÃ¼
Write-ColorOutput "ğŸš€ Ã‡ok dilli geri bildirim testleri baÅŸlatÄ±lÄ±yor..." "White"
Write-ColorOutput ""

# Testleri Ã§alÄ±ÅŸtÄ±r
Test-MultiLanguageFeedback -TestName "Dil DesteÄŸi" -TestScript { Test-LanguageSupport }
Test-MultiLanguageFeedback -TestName "Geri Bildirim Ä°ÅŸleme" -TestScript { Test-FeedbackProcessing }
Test-MultiLanguageFeedback -TestName "GÃ¼nlÃ¼k Limit" -TestScript { Test-DailyLimit }
Test-MultiLanguageFeedback -TestName "Duygu Analizi" -TestScript { Test-SentimentAnalysis }
Test-MultiLanguageFeedback -TestName "Otomatik YanÄ±t" -TestScript { Test-AutoResponse }

# Test Ã¶zeti
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           ğŸ“Š Test SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

$successRate = if ($testResults.TotalTests -gt 0) {
    [math]::Round(($testResults.PassedTests / $testResults.TotalTests) * 100, 1)
} else { 0 }

Write-ColorOutput "Toplam Test: $($testResults.TotalTests)" "White"
Write-ColorOutput "BaÅŸarÄ±lÄ±: $($testResults.PassedTests)" "Green"
Write-ColorOutput "BaÅŸarÄ±sÄ±z: $($testResults.FailedTests)" "Red"
Write-ColorOutput "BaÅŸarÄ± OranÄ±: $successRate%" "Cyan"
Write-ColorOutput "Toplam SÃ¼re: $($testResults.TestDuration.TotalSeconds) saniye" "White"

# DetaylÄ± sonuÃ§lar
if ($Verbose) {
    Write-ColorOutput "" "White"
    Write-ColorOutput "DetaylÄ± SonuÃ§lar:" "Yellow"
    foreach ($detail in $testResults.Details) {
        $status = if ($detail.Passed) { "âœ…" } else { "âŒ" }
        Write-ColorOutput "  $status $($detail.TestName)" "White"
        if (!$detail.Passed -and $detail.ErrorMessage) {
            Write-ColorOutput "    Hata: $($detail.ErrorMessage)" "Red"
        }
    }
}

# JSON export
if ($ExportJson) {
    $jsonPath = Join-Path $ProjectPath "feedback-test-results.json"
    $exportData = @{
        metadata = @{
            timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
            script_version = "1.0.0"
            test_environment = $TestEnvironment
            supported_languages = $TestLanguages
            max_feedbacks_per_day = $MaxFeedbacksPerDay
            total_duration_seconds = $testResults.TestDuration.TotalSeconds
        }
        summary = @{
            total_tests = $testResults.TotalTests
            passed_tests = $testResults.PassedTests
            failed_tests = $testResults.FailedTests
            success_rate = $successRate
            test_duration = $testResults.TestDuration.ToString()
        }
        language_support = @{
            tested_languages = $TestLanguages
            sample_feedbacks_created = $true
        }
        details = $testResults.Details
        recommendations = @(
            "Desteklenen dilleri environment variable ile yapÄ±landÄ±rÄ±n",
            "GÃ¼nlÃ¼k feedback limitini production ortamÄ±na gÃ¶re ayarlayÄ±n",
            "Duygu analizi algoritmasÄ±nÄ± geliÅŸtirmek iÃ§in daha fazla Ã¶rnek kullanÄ±n",
            "Otomatik yanÄ±tlarÄ± kullanÄ±cÄ± deneyimine gÃ¶re Ã¶zelleÅŸtirin"
        )
    }

    $exportData | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
    Write-ColorOutput "ğŸ“„ Test sonuÃ§larÄ± JSON olarak kaydedildi: $jsonPath" "Green"
}

# Badge tetikleme
if ($testResults.PassedTests -gt 0) {
    Show-Badge "Feedback-Globalized"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($testResults.FailedTests -eq 0) {
    Write-ColorOutput "ğŸ‰ TÃ¼m Ã§ok dilli geri bildirim testleri baÅŸarÄ±lÄ±! CI/CD pipeline devam edebilir." "Green"
    exit 0
} else {
    Write-ColorOutput "ğŸ’¥ BazÄ± geri bildirim testleri baÅŸarÄ±sÄ±z. LÃ¼tfen dil desteÄŸi ayarlarÄ±nÄ± kontrol edin." "Red"
    exit 1
}

# Badge gÃ¶sterme fonksiyonu
function Show-Badge {
    param([string]$BadgeName)

    Write-ColorOutput "ğŸ… Badge kazanÄ±ldÄ±: $BadgeName" "Cyan"

    # Badge dosyasÄ±nÄ± gÃ¼ncelle (varsa)
    $badgeFile = Join-Path $ProjectPath "badge.json"
    if (Test-Path $badgeFile) {
        try {
            $badgeData = Get-Content $badgeFile -Raw | ConvertFrom-Json
            if ($badgeData.PSObject.Properties.Name -notcontains $BadgeName) {
                $badgeData | Add-Member -MemberType NoteProperty -Name $BadgeName -Value $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            } else {
                $badgeData.$BadgeName = $true
                $badgeData | ConvertTo-Json | Set-Content $badgeFile
                Write-ColorOutput "  âœ… Badge dosyasÄ± gÃ¼ncellendi" "Green"
            }
        } catch {
            Write-ColorOutput "  âš ï¸  Badge dosyasÄ± gÃ¼ncellenemedi" "Yellow"
        }
    } else {
        # Yeni badge dosyasÄ± oluÅŸtur
        $newBadgeData = @{
            $BadgeName = $true
        }
        $newBadgeData | ConvertTo-Json | Set-Content $badgeFile
        Write-ColorOutput "  âœ… Yeni badge dosyasÄ± oluÅŸturuldu" "Green"
    }
}
