# Test-Routing.ps1 - CI/CD pipeline ile entegre routing test scripti
# Bu script routing servislerinin test edilmesi iÃ§in kullanÄ±lÄ±r

param(
    [string]$TestEnvironment = "local",
    [string]$Configuration = "Debug",
    [string]$ProjectPath = $PSScriptRoot,
    [switch]$SkipBuild,
    [switch]$Verbose
)

# Script ayarlarÄ±
$ErrorActionPreference = "Stop"
$VerbosePreference = if ($Verbose) { "Continue" } else { "SilentlyContinue" }

# Renkli output iÃ§in
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

# BaÅŸlÄ±k
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "    Kesif Uygulamasi - Routing Testleri" "Cyan"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput ""

# Environment deÄŸiÅŸkenlerini ayarla
$env:TEST_ENVIRONMENT = $TestEnvironment
$env:CI = if ($TestEnvironment -eq "ci") { "true" } else { "false" }
$env:DOTNET_ENVIRONMENT = if ($TestEnvironment -eq "ci") { "Production" } else { "Development" }

Write-ColorOutput "Test Environment: $TestEnvironment" "Yellow"
Write-ColorOutput "Configuration: $Configuration" "Yellow"
Write-ColorOutput "Project Path: $ProjectPath" "Yellow"
Write-ColorOutput ""

# Proje yolunu kontrol et
if (!(Test-Path $ProjectPath)) {
    Write-ColorOutput "Hata: Proje yolu bulunamadÄ±: $ProjectPath" "Red"
    exit 1
}

# .NET SDK kontrolÃ¼
Write-ColorOutput "ðŸ” .NET SDK kontrol ediliyor..." "White"
try {
    $dotnetVersion = dotnet --version
    Write-ColorOutput "âœ… .NET SDK bulundu: $dotnetVersion" "Green"
} catch {
    Write-ColorOutput "âŒ .NET SDK bulunamadÄ±. LÃ¼tfen .NET SDK yÃ¼kleyin." "Red"
    exit 1
}

# Build iÅŸlemi
if (!$SkipBuild) {
    Write-ColorOutput "ðŸ”¨ Proje build ediliyor..." "White"
    try {
        Push-Location $ProjectPath
        dotnet build --configuration $Configuration --verbosity minimal
        Write-ColorOutput "âœ… Build baÅŸarÄ±lÄ±" "Green"
    } catch {
        Write-ColorOutput "âŒ Build baÅŸarÄ±sÄ±z: $($_.Exception.Message)" "Red"
        exit 1
    } finally {
        Pop-Location
    }
} else {
    Write-ColorOutput "â­ï¸  Build atlandÄ±" "Yellow"
}

# Test sonuÃ§larÄ± iÃ§in klasÃ¶r oluÅŸtur
$testResultsPath = Join-Path $ProjectPath "TestResults"
if (!(Test-Path $testResultsPath)) {
    New-Item -ItemType Directory -Path $testResultsPath | Out-Null
}

# Test Ã§alÄ±ÅŸtÄ±rma fonksiyonu
function Invoke-RoutingTests {
    param(
        [string]$TestProject,
        [string]$Filter = "",
        [string]$DisplayName = ""
    )

    Write-ColorOutput "ðŸ§ª $DisplayName testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..." "White"

    $testArgs = @(
        "test",
        $TestProject,
        "--configuration", $Configuration,
        "--logger", "trx;LogFileName=$testResultsPath\$DisplayName.trx",
        "--logger", "console;verbosity=detailed",
        "--results-directory", $testResultsPath
    )

    if ($Filter) {
        $testArgs += "--filter", $Filter
    }

    if ($Verbose) {
        $testArgs += "--verbosity", "normal"
    } else {
        $testArgs += "--verbosity", "minimal"
    }

    try {
        Push-Location $ProjectPath
        dotnet $testArgs
        Write-ColorOutput "âœ… $DisplayName testleri baÅŸarÄ±lÄ±" "Green"
        return $true
    } catch {
        Write-ColorOutput "âŒ $DisplayName testleri baÅŸarÄ±sÄ±z: $($_.Exception.Message)" "Red"
        return $false
    } finally {
        Pop-Location
    }
}

# Routing testlerini Ã§alÄ±ÅŸtÄ±r
$allTestsPassed = $true

# RouteService testleri
$routeServiceTest = Join-Path $ProjectPath "KesifUygulamasiTemplate.Tests\KesifUygulamasiTemplate.Tests.csproj"
if (Test-Path $routeServiceTest) {
    $result = Invoke-RoutingTests -TestProject $routeServiceTest -Filter "RouteService" -DisplayName "RouteService"
    $allTestsPassed = $allTestsPassed -and $result
} else {
    Write-ColorOutput "âš ï¸  RouteService test projesi bulunamadÄ±: $routeServiceTest" "Yellow"
}

# Route optimization testleri
if (Test-Path $routeServiceTest) {
    $result = Invoke-RoutingTests -TestProject $routeServiceTest -Filter "RouteOptimization" -DisplayName "RouteOptimization"
    $allTestsPassed = $allTestsPassed -and $result
}

# Monitoring service testleri
$monitoringTest = Join-Path $ProjectPath "KesifUygulamasiTemplate.Tests\KesifUygulamasiTemplate.Tests.csproj"
if (Test-Path $monitoringTest) {
    $result = Invoke-RoutingTests -TestProject $monitoringTest -Filter "Monitoring" -DisplayName "MonitoringService"
    $allTestsPassed = $allTestsPassed -and $result
}

# Integration testleri
$integrationTest = Join-Path $ProjectPath "KesifUygulamasiTemplate.Tests\KesifUygulamasiTemplate.Tests.csproj"
if (Test-Path $integrationTest) {
    $result = Invoke-RoutingTests -TestProject $integrationTest -Filter "Integration" -DisplayName "Integration"
    $allTestsPassed = $allTestsPassed -and $result
}

# Test sonuÃ§larÄ±nÄ± Ã¶zetle
Write-ColorOutput "" "White"
Write-ColorOutput "=========================================" "Cyan"
Write-ColorOutput "           Test SonuÃ§larÄ±" "Cyan"
Write-ColorOutput "=========================================" "Cyan"

# Test sonuÃ§ dosyalarÄ±nÄ± listele
$trxFiles = Get-ChildItem $testResultsPath -Filter "*.trx" -ErrorAction SilentlyContinue
if ($trxFiles) {
    Write-ColorOutput "Test sonuÃ§ dosyalarÄ±:" "White"
    foreach ($file in $trxFiles) {
        Write-ColorOutput "  ðŸ“„ $($file.Name)" "Gray"
    }
} else {
    Write-ColorOutput "Test sonuÃ§ dosyasÄ± bulunamadÄ±" "Yellow"
}

# Coverage raporu oluÅŸtur (varsa)
$coveragePath = Join-Path $ProjectPath "coverage"
if (Test-Path $coveragePath) {
    Write-ColorOutput "ðŸ“Š Coverage raporu mevcut: $coveragePath" "Green"
} else {
    Write-ColorOutput "ðŸ“Š Coverage raporu bulunamadÄ±" "Yellow"
}

# Final sonuÃ§
Write-ColorOutput "" "White"
if ($allTestsPassed) {
    Write-ColorOutput "ðŸŽ‰ TÃ¼m testler baÅŸarÄ±lÄ±! CI/CD pipeline devam edebilir." "Green"
    exit 0
} else {
    Write-ColorOutput "ðŸ’¥ BazÄ± testler baÅŸarÄ±sÄ±z. LÃ¼tfen hatalarÄ± dÃ¼zeltin." "Red"
    exit 1
}

# Test helper fonksiyonlarÄ±
function Test-RouteCalculation {
    param(
        [string]$StartLocation = "Ä°stanbul",
        [string]$EndLocation = "Ankara",
        [string]$OptimizationType = "Fastest"
    )

    Write-ColorOutput "Testing route calculation: $StartLocation -> $EndLocation ($OptimizationType)" "White"

    # Burada gerÃ§ek test kodu Ã§alÄ±ÅŸtÄ±rÄ±labilir
    # Åžimdilik sadece mock test
    Start-Sleep -Milliseconds 100
    Write-ColorOutput "âœ… Route calculation test passed" "Green"
}

function Test-ProviderSwitching {
    Write-ColorOutput "Testing provider switching..." "White"

    $providers = @("Google", "Mapbox", "HERE")
    foreach ($provider in $providers) {
        Write-ColorOutput "  Testing $provider provider..." "Gray"
        Start-Sleep -Milliseconds 50
    }

    Write-ColorOutput "âœ… Provider switching test passed" "Green"
}

function Test-OfflineMode {
    Write-ColorOutput "Testing offline mode..." "White"

    # Offline mode test kodu
    Start-Sleep -Milliseconds 200
    Write-ColorOutput "âœ… Offline mode test passed" "Green"
}

# Ek test fonksiyonlarÄ± (CI/CD'de kullanÄ±labilir)
if ($TestEnvironment -eq "ci") {
    Write-ColorOutput "" "White"
    Write-ColorOutput "ðŸ”§ CI/CD ek testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..." "White"

    Test-RouteCalculation
    Test-ProviderSwitching
    Test-OfflineMode

    Write-ColorOutput "âœ… CI/CD ek testleri tamamlandÄ±" "Green"
}

Write-ColorOutput "" "White"
Write-ColorOutput "Script tamamlandÄ±." "Cyan"
